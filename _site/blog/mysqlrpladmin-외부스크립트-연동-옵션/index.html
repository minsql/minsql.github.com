<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  

  
    
    <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>mysqlrpladmin 외부스크립트 연동 옵션 | MINSQL</title>
<meta name="generator" content="Jekyll v3.5.2" />
<meta property="og:title" content="mysqlrpladmin 외부스크립트 연동 옵션" />
<meta name="author" content="MIN KIM" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="mysqlrpladmin 외부스크립트 연동 옵션" />
<meta property="og:description" content="mysqlrpladmin 외부스크립트 연동 옵션" />
<link rel="canonical" href="http://localhost:4000/blog/mysqlrpladmin-%EC%99%B8%EB%B6%80%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8-%EC%97%B0%EB%8F%99-%EC%98%B5%EC%85%98/" />
<meta property="og:url" content="http://localhost:4000/blog/mysqlrpladmin-%EC%99%B8%EB%B6%80%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8-%EC%97%B0%EB%8F%99-%EC%98%B5%EC%85%98/" />
<meta property="og:site_name" content="MINSQL" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-02-12T00:00:00+09:00" />
<script type="application/ld+json">
{"description":"mysqlrpladmin 외부스크립트 연동 옵션","author":{"@type":"Person","name":"MIN KIM"},"@type":"BlogPosting","url":"http://localhost:4000/blog/mysqlrpladmin-%EC%99%B8%EB%B6%80%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8-%EC%97%B0%EB%8F%99-%EC%98%B5%EC%85%98/","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/site-logo.png"},"name":"MIN KIM"},"headline":"mysqlrpladmin 외부스크립트 연동 옵션","dateModified":"2015-02-12T00:00:00+09:00","datePublished":"2015-02-12T00:00:00+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/mysqlrpladmin-%EC%99%B8%EB%B6%80%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8-%EC%97%B0%EB%8F%99-%EC%98%B5%EC%85%98/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  

  <script>
    /* Cut the mustard */
    if ( 'querySelector' in document && 'addEventListener' in window ) {
      document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + 'js';
    }
  </script>

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="alternate" type="application/atom+xml" title="MINSQL" href="/feed.xml">
<!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

</head>

</head>

<body id="post">


  <div class="navigation-wrapper">
    <a href="#menu-toggle" id="menu-toggle">Menu</a>
    <nav id="primary-nav" class="site-nav animated drop">
      <ul><li><a href="/">Home</a></li><li><a href="/about/">About</a></li><li><a href="/blog/">Blog</a></li><li><a href="/tags/">Tags</a></li><li><a href="/search/">Search</a></li></ul>
    </nav>
  </div><!-- /.navigation-wrapper -->



<div id="main" role="main">
  <article class="entry">
    
  <!--  <img src="http://localhost:4000/images/mysql.png" class="entry-feature-image" alt="mysqlrpladmin 외부스크립트 연동 옵션" >-->
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="http://localhost:4000/tags/#MySQL" title="Pages tagged MySQL">MySQL</a></li>
        </ul>
        
          <h1 class="entry-title">mysqlrpladmin 외부스크립트 연동 옵션</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="http://localhost:4000/images/fabmichaela-photo.jpg" class="bio-photo" alt="MIN KIM bio photo"/>
        
        <span class="author vcard">By <span class="fn">MIN KIM</span></span>
        <span class="entry-date date published"><time datetime="2015-02-12T00:00:00+09:00"><i class="fa fa-calendar-o"></i> February 12, 2015</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        <div class="page-share">
  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fblog%2Fmysqlrpladmin-%25EC%2599%25B8%25EB%25B6%2580%25EC%258A%25A4%25ED%2581%25AC%25EB%25A6%25BD%25ED%258A%25B8-%25EC%2597%25B0%25EB%258F%2599-%25EC%2598%25B5%25EC%2585%2598%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--facebook btn--small"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i> <span>Share</span></a>
  <a href="https://twitter.com/intent/tweet?text=mysqlrpladmin+%EC%99%B8%EB%B6%80%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8+%EC%97%B0%EB%8F%99+%EC%98%B5%EC%85%98%20http%3A%2F%2Flocalhost%3A4000%2Fblog%2Fmysqlrpladmin-%25EC%2599%25B8%25EB%25B6%2580%25EC%258A%25A4%25ED%2581%25AC%25EB%25A6%25BD%25ED%258A%25B8-%25EC%2597%25B0%25EB%258F%2599-%25EC%2598%25B5%25EC%2585%2598%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--twitter btn--small"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i> <span>Tweet</span></a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fblog%2Fmysqlrpladmin-%25EC%2599%25B8%25EB%25B6%2580%25EC%258A%25A4%25ED%2581%25AC%25EB%25A6%25BD%25ED%258A%25B8-%25EC%2597%25B0%25EB%258F%2599-%25EC%2598%25B5%25EC%2585%2598%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--linkedin btn--small"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> <span>LinkedIn</span></a>
  <a href="https://reddit.com/submit?title=mysqlrpladmin+%EC%99%B8%EB%B6%80%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8+%EC%97%B0%EB%8F%99+%EC%98%B5%EC%85%98&url=http%3A%2F%2Flocalhost%3A4000%2Fblog%2Fmysqlrpladmin-%25EC%2599%25B8%25EB%25B6%2580%25EC%258A%25A4%25ED%2581%25AC%25EB%25A6%25BD%25ED%258A%25B8-%25EC%2597%25B0%25EB%258F%2599-%25EC%2598%25B5%25EC%2585%2598%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--reddit btn--small"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i> <span>Reddit</span></a>
</div>

        

          <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-cog"></i> My Table of Contents</h4></header>
              <ul class="toc__menu">
  <li><a href="#mysqlrpladmin-외부스크립트-연동-옵션-1">mysqlrpladmin 외부스크립트 연동 옵션</a></li>
</ul>
            </nav>
        <div class="google-ads" style="margin-top:40px; text-align:center;">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- 160x600 ad -->
  <ins class="adsbygoogle"
       style="display:inline-block;width:160px;height:600px"
       data-ad-client="ca-pub-2669792816970567"
       data-ad-slot="6147132222"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div><!-- /.google-ads --><!-- /.google-ads -->
        
      </footer>
      <div class="entry-content">
        <h1 id="mysqlrpladmin-외부스크립트-연동-옵션">mysqlrpladmin 외부스크립트 연동 옵션</h1>

<h3 id="mysqlrpladmin-외부스크립트-연동-옵션-1">mysqlrpladmin 외부스크립트 연동 옵션</h3>

<blockquote>
  <p>mysqlrpladmin failover/switchover 에서 활용가능한 외부스크립트 연동 옵션입니다.</p>
</blockquote>

<p> </p>

<ul>
  <li>mysqlrpladmin을 통한 failover/switchover하기 전이나 후에 외부 스크립트를 수행하게 할수 있습니다. (** _--exec-before=<script>, --exec-after=<script>_** )</script></script></li>
  <li>만약 mysqlrpladmin전에 외부 스크립트를 사용하는 경우, 해당 스크립트의 결과값에 따라 mysqlrpladmin 동작을 제어할수 있습니다. (** _--script-threshold=<return_code>_** )</return_code></li>
</ul>

<h4 id="다음과-같이-disk-availability-checkup하는-스크립트를-미리-수행하길-원하는-경우를-테스트해봅시다">다음과 같이 disk availability checkup하는 스크립트를 미리 수행하길 원하는 경우를 테스트해봅시다.</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>[mysql@myvm1 db]$ more test_disk_mysql56m3.sh
touch /data1/multi/5.6/data3/test.out 2 &gt; /dev/null

if [ $? -eq 0 ]
then
  echo "Successfully created file"
  exit 0
else
  echo "Could not create file" &gt;&amp;2
  exit 1
fi
</code></pre>
</div>

<h4 id="1-현-replication구성-현황-확인">1. 현 Replication구성 현황 확인</h4>

<p>참고로 connection information에는 login-path를 사용하였습니다. login-path 구성은 다음 게시글 참조해주세요 : <a href="http://minsql.890m.com/mysql/mysql-login-path/">MySQL login-path</a></p>

<div class="highlighter-rouge"><pre class="highlight"><code>[mysql@myvm1 db]$  mysqlrpladmin --master=multi56_mysql2 --discover-slaves-login=multi56_mysql2 health
# Discovering slaves for master at localhost:3367
# Discovering slave at localhost:3366
# Found slave: localhost:3366
# Discovering slave at localhost:3368
# Found slave: localhost:3368
# Checking privileges.
#
# Replication Topology Health:
+------------+-------+---------+--------+------------+---------+
| host       | port  | role    | state  | gtid_mode  | health  |
+------------+-------+---------+--------+------------+---------+
| localhost  | 3367  | MASTER  | UP     | ON         | OK      |
| localhost  | 3366  | SLAVE   | UP     | ON         | OK      |
| localhost  | 3368  | SLAVE   | UP     | ON         | OK      |
+------------+-------+---------+--------+------------+---------+
# ...done.
[mysql@myvm1 db]$
</code></pre>
</div>

<h4 id="2-port-3368-mysql-instance의-data-directory가-사용불가능한-상태에서-테스트">2. port 3368 mysql instance의 data directory가 사용불가능한 상태에서 테스트</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>[mysql@myvm1 db]$ su - root
Password:
[root@myvm1 ~]# cd /data1/multi/5.6/
[root@myvm1 5.6]# chown -R root. data3
[root@myvm1 5.6]# exit
logout

[mysql@myvm1 db]$ ./test_disk_mysql56m3.sh
Could not create file


[mysql@myvm1 db]$ mysqlrpladmin --master=multi56_mysql2 --discover-slaves-login=multi56_mysql2 health
# Discovering slaves for master at localhost:3367
# Discovering slave at localhost:3366
# Found slave: localhost:3366
# Discovering slave at localhost:3368
# Found slave: localhost:3368
# Checking privileges.
#
# Replication Topology Health:
+------------+-------+---------+--------+------------+---------+
| host       | port  | role    | state  | gtid_mode  | health  |
+------------+-------+---------+--------+------------+---------+
| localhost  | 3367  | MASTER  | UP     | ON         | OK      |
| localhost  | 3366  | SLAVE   | UP     | ON         | OK      |
| localhost  | 3368  | SLAVE   | UP     | ON         | OK      |
+------------+-------+---------+--------+------------+---------+
# ...done.
[mysql@myvm1 db]$
</code></pre>
</div>

<h5 id="switchover-시도">switchover 시도</h5>

<div class="highlighter-rouge"><pre class="highlight"><code>[mysql@myvm1 db]$ mysqlrpladmin --exec-before=/db/test_disk_mysql56m3.sh --script-threshold=1 --demote-master --master=multi56_mysql2 --new-master=multi56_mysql3 --slaves=multi56_mysql1,multi56_mysql3 --verbose switchover
WARNING: You have chosen to use external script return code checking. Depending on which script fails, this can leave the operation in an undefined state. Please check your results carefully if the operation aborts.
# Checking privileges.
# Performing switchover from master at localhost:3367 to slave at localhost:3368.
# Checking candidate slave prerequisites.
# GTID_MODE=ON is set for all servers.
# Checking eligibility of slave localhost:3368 for candidate.
#   Slave connected to master ... Ok
#   GTID_MODE=ON ... Ok
#   Logging filters agree ... Ok
#   Replication user exists ... Ok
# Checking slaves configuration to master.
# Creating replication user if it does not exist.
# Spawning external script.
# SCRIPT EXECUTED: /db/test_disk_mysql56m3.sh localhost 3367 localhost 3368
Could not create file
ERROR: External script '/db/test_disk_mysql56m3.sh' failed. Result = 1.
Specified threshold exceeded. Operation aborted.
WARNING: The operation did not complete. Depending on when the external script was called, you should check the topology for inconsistencies.
[mysql@myvm1 db]$
</code></pre>
</div>

<p><strong>외부 스크립트가 result=1로 fail했기 때문에 Operation이 멈추었습니다.</strong>  </p>

<h4 id="3-디스크가-사용가능한-상태에서-테스트">3. 디스크가 사용가능한 상태에서 테스트</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>[mysql@myvm1 db]$ su - root
Password:
[root@myvm1 ~]# cd /data1/multi/5.6/
[root@myvm1 5.6]# chown -R mysql. data3
[root@myvm1 5.6]# exit
logout
[mysql@myvm1 db]$ ./test_disk_mysql56m3.sh
Successfully created file
</code></pre>
</div>

<p>switchover 시도</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[mysql@myvm1 db]$ mysqlrpladmin --exec-before=/db/test_disk_mysql56m3.sh --script-threshold=1 --demote-master --master=multi56_mysql2 --new-master=multi56_mysql3 --slaves=multi56_mysql1,multi56_mysql3 --verbose switchover
WARNING: You have chosen to use external script return code checking. Depending on which script fails, this can leave the operation in an undefined state. Please check your results carefully if the operation aborts.
# Checking privileges.
# Performing switchover from master at localhost:3367 to slave at localhost:3368.
# Checking candidate slave prerequisites.
# GTID_MODE=ON is set for all servers.
# Checking eligibility of slave localhost:3368 for candidate.
#   Slave connected to master ... Ok
#   GTID_MODE=ON ... Ok
#   Logging filters agree ... Ok
#   Replication user exists ... Ok
# Checking slaves configuration to master.
# Creating replication user if it does not exist.
# Spawning external script.
# SCRIPT EXECUTED: /db/test_disk_mysql56m3.sh localhost 3367 localhost 3368
Successfully created file
# Script completed Ok.
# Blocking writes on master.
# LOCK STRING: FLUSH TABLES WITH READ LOCK
# Waiting for slaves to catch up to old master.
# Slave localhost:3366:
# QUERY = SELECT WAIT_UNTIL_SQL_THREAD_AFTER_GTIDS('141c523b-4747-11e4-98fb-000c298227a2:1-1531', 300)
# Return Code = 0
# Slave localhost:3366:
# QUERY = SELECT WAIT_UNTIL_SQL_THREAD_AFTER_GTIDS('8e95986b-4747-11e4-98fe-000c298227a2:1-15', 300)
# Return Code = 0
# Slave localhost:3368:
# QUERY = SELECT WAIT_UNTIL_SQL_THREAD_AFTER_GTIDS('141c523b-4747-11e4-98fb-000c298227a2:1-1531', 300)
# Return Code = 0
# Slave localhost:3368:
# QUERY = SELECT WAIT_UNTIL_SQL_THREAD_AFTER_GTIDS('8e95986b-4747-11e4-98fe-000c298227a2:1-15', 300)
# Return Code = 0
# Stopping slaves.
# Performing STOP on all slaves.
#   Executing stop on slave localhost:3366 Ok
#   Executing stop on slave localhost:3368 Ok
# UNLOCK STRING: UNLOCK TABLES
# Demoting old master to be a slave to the new master.
# Switching slaves to new master.
# Executing CHANGE MASTER on localhost:3366.
# CHANGE MASTER TO MASTER_HOST = 'localhost', MASTER_USER = 'replication', MASTER_PASSWORD = 'replication', MASTER_PORT = 3368, MASTER_AUTO_POSITION=1
# Executing CHANGE MASTER on localhost:3367.
# CHANGE MASTER TO MASTER_HOST = 'localhost', MASTER_USER = 'replication', MASTER_PASSWORD = 'replication', MASTER_PORT = 3368, MASTER_AUTO_POSITION=1
# Starting all slaves.
# Performing START on all slaves.
#   Executing start on slave localhost:3366 Ok
#   Executing start on slave localhost:3367 Ok
# Checking slaves for errors.
# localhost:3366 status: Ok
# localhost:3367 status: Ok
# Switchover complete.
# Attempting to contact localhost ... Success
# Attempting to contact localhost ... Success
# Attempting to contact localhost ... Success
#
# Replication Topology Health:
# Replication Topology Health:
+------------+-------+---------+--------+------------+---------+-------------+-----------------------+-----------------+------------+-------------+--------------+------------------+---------------+-----------+----------------+------------+---------------+
| host       | port  | role    | state  | gtid_mode  | health  | version     | master_log_file       | master_log_pos  | IO_Thread  | SQL_Thread  | Secs_Behind  | Remaining_Delay  | IO_Error_Num  | IO_Error  | SQL_Error_Num  | SQL_Error  | Trans_Behind  |
+------------+-------+---------+--------+------------+---------+-------------+-----------------------+-----------------+------------+-------------+--------------+------------------+---------------+-----------+----------------+------------+---------------+
| localhost  | 3368  | MASTER  | UP     | ON         | OK      | 5.6.19-log  | mysql56m3-bin.000013  | 864             |            |             |              |                  |               |           |                |            |               |
| localhost  | 3366  | SLAVE   | UP     | ON         | OK      | 5.6.19-log  | mysql56m3-bin.000013  | 864             | Yes        | Yes         | 0            | No               | 0             |           | 0              |            | 0             |
| localhost  | 3367  | SLAVE   | UP     | ON         | OK      | 5.6.19-log  | mysql56m3-bin.000013  | 864             | Yes        | Yes         | 0            | No               | 0             |           | 0              |            | 0             |
+------------+-------+---------+--------+------------+---------+-------------+-----------------------+-----------------+------------+-------------+--------------+------------------+---------------+-----------+----------------+------------+---------------+
# ...done.
[mysql@myvm1 db]$
</code></pre>
</div>

<p>이번에는 before 스크립트가 성공하고 switchover동작도 성공하였습니다.
실전에서는 요구사항에 따라 유용하게 사용할수 있을 듯합니다.</p>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="http://localhost:4000/blog/MySQL-%E1%84%8B%E1%85%A6%E1%84%85%E1%85%A5%E1%84%86%E1%85%A6%E1%84%89%E1%85%B5%E1%84%8C%E1%85%B5-%E1%84%8B%E1%85%A5%E1%86%AB%E1%84%8B%E1%85%A5-%E1%84%89%E1%85%A5%E1%86%AF%E1%84%8C%E1%85%A5%E1%86%BC/" class="btn" title="MySQL 에러메시지 언어 설정">Previous</a>
      
      
        <a href="http://localhost:4000/blog/MySQL-%E1%84%8B%E1%85%B4-show-slave-status-%E1%84%8B%E1%85%A6%E1%84%89%E1%85%A5-Seconds_Behind_Master-%E1%84%82%E1%85%B3%E1%86%AB-%E1%84%86%E1%85%AE%E1%84%8B%E1%85%A5%E1%86%BA%E1%84%8B%E1%85%B3%E1%86%AF-%E1%84%80%E1%85%B5%E1%84%8C%E1%85%AE%E1%86%AB%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9-%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%83%E1%85%AC%E1%84%82%E1%85%B3%E1%86%AB%E1%84%80%E1%85%A1/" class="btn" title="MySQL 의 show slave status 에서 Seconds_Behind_Master 는 무엇을 기준으로 결정되는가">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    <footer id="footer" class="site-footer">
  <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
<div class="copyright">
    
      <p>&copy; 2019 MINSQL. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/mmistakes/so-simple-theme" rel="nofollow">So Simple</a>.</p>
    
  </div>
</footer>

  </footer>
</div><!-- /.footer-wrapper -->

<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.12/js/all.js"></script>


<!-- MathJax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


</body>
</html>
