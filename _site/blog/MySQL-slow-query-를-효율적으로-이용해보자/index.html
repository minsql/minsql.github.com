<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>MySQL slow query 를 효율적으로 이용해보자! &#8211; MINSQL</title>
<meta name="description" content="MySQL slow query 를 효율적으로 이용해보자!

">
<meta name="keywords" content="MySQL">


<!-- Twitter Cards -->
<meta name="twitter:title" content="MySQL slow query 를 효율적으로 이용해보자!">
<meta name="twitter:description" content="MySQL slow query 를 효율적으로 이용해보자!

">



<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:4000/images/mysql.png">

<!-- Open Graph -->
<meta property="og:locale" content="ko_KR">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL slow query 를 효율적으로 이용해보자!">
<meta property="og:description" content="MySQL slow query 를 효율적으로 이용해보자!

">
<meta property="og:url" content="http://localhost:4000/blog/MySQL-slow-query-%EB%A5%BC-%ED%9A%A8%EC%9C%A8%EC%A0%81%EC%9C%BC%EB%A1%9C-%EC%9D%B4%EC%9A%A9%ED%95%B4%EB%B3%B4%EC%9E%90/">
<meta property="og:site_name" content="MINSQL">





<link rel="canonical" href="http://localhost:4000/blog/MySQL-slow-query-%EB%A5%BC-%ED%9A%A8%EC%9C%A8%EC%A0%81%EC%9C%BC%EB%A1%9C-%EC%9D%B4%EC%9A%A9%ED%95%B4%EB%B3%B4%EC%9E%90/">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="MINSQL Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="http://localhost:4000/assets/js/vendor/html5shiv.min.js"></script>
  <script src="http://localhost:4000/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		    <li><a href="http://localhost:4000/about/" >About</a></li>
		  
		    
		    <li><a href="http://localhost:4000/blog/" >Blog</a></li>
		  
		    
		    <li><a href="http://localhost:4000/tags/" >Tags</a></li>
		  
		    
		    <li><a href="http://localhost:4000/search/" >Search</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->


<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="entry">
    
  <!--  <img src="http://localhost:4000/images/mysql.png" class="entry-feature-image" alt="MySQL slow query 를 효율적으로 이용해보자!" >-->
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="http://localhost:4000/tags/#MySQL" title="Pages tagged MySQL">MySQL</a></li>
        </ul>
        
          <h1 class="entry-title">MySQL slow query 를 효율적으로 이용해보자!</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="http://localhost:4000/images/makayal-photo.jpg" class="bio-photo" alt="MIN CHO bio photo"/>
        
        <span class="author vcard">By <span class="fn">MIN CHO</span></span>
        <span class="entry-date date published"><time datetime="2016-12-15T00:00:00+09:00"><i class="fa fa-calendar-o"></i> December 15, 2016</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        
        

        

          <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-cog"></i> My Table of Contents</h4></header>
              <ul class="toc__menu">
  <li><a href="#개요">개요</a></li>
  <li><a href="#slow-query-에-쓰여지는것들">Slow query 에 쓰여지는것들</a>
    <ul>
      <li><a href="#1-long_query_time-이상으로-실행되는-쿼리에-대하여-slow_query_log_file-에-존재하는-파일에-slow-query-를-작성한다">1. long_query_time 이상으로 실행되는 쿼리에 대하여, slow_query_log_file 에 존재하는 파일에 slow query 를 작성한다.</a></li>
      <li><a href="#2-index-를-사용하지-않는-쿼리들">2. Index 를 사용하지 않는 쿼리들</a></li>
      <li><a href="#3-admin-관련-명령어-혹은-slave-의-sql_thread-에-의해-실행된-명령어중-long_query_time-이상으로-실행된-명령어를-찾는다">3. Admin 관련 명령어 혹은 slave 의 sql_thread 에 의해 실행된 명령어중 long_query_time 이상으로 실행된 명령어를 찾는다.</a></li>
    </ul>
  </li>
  <li><a href="#효율적으로-활용하기">효율적으로 활용하기</a>
    <ul>
      <li><a href="#1-long-query-time-과-mysqldumpslow를-이용하여-쿼리의-종류와-횟수-계산하기">1. long-query-time 과 mysqldumpslow를 이용하여, 쿼리의 종류와 횟수 계산하기</a></li>
      <li><a href="#2-min_examined_row_limit-를-이용하여-특정-row-이상으로-검사한-쿼리만-찾기">2. min_examined_row_limit 를 이용하여, 특정 row 이상으로 검사한 쿼리만 찾기.</a></li>
      <li><a href="#추천하는-설정">추천하는 설정</a></li>
    </ul>
  </li>
</ul>
            </nav>

        
      </footer>
      <div class="entry-content">
        <h1 id="mysql-slow-query-를-효율적으로-이용해보자">MySQL slow query 를 효율적으로 이용해보자!</h1>

<h2 id="개요">개요</h2>

<ul>
  <li>MySQL 은 slow query 를 사용하여, 많은 정보를 얻어낼 수 있다. 하지만, 해당 기능들이 default 로 OFF 로 되어 있어 그냥 지나가는 경우가 많다. slow query 관련한 기능들을 알아보자.
    <ul>
      <li>Slow query 파일은 쿼리를 튜닝하는데 아주 중요한 요소로 작용하지만, 5.6부터는 해당 기능이 default 로 OFF 되어 있다. 먼저 아래에 나열된 모든 기능을 사용하기 위해서는 slow_query_log 를 ON 으로 설정해야 한다.</li>
      <li>해당값은 dynamic 변수로서 set global slow_query_log=ON; 와 같이 변경가능하다.</li>
      <li>my.cnf 의 [mysqld] section 에 slow_query_log 를 추가하여 restart 후에도 해당 값이 ON 이 될 수있도록 조정한다.</li>
    </ul>
  </li>
</ul>

<h2 id="slow-query-에-쓰여지는것들">Slow query 에 쓰여지는것들</h2>

<h3 id="1-long_query_time-이상으로-실행되는-쿼리에-대하여-slow_query_log_file-에-존재하는-파일에-slow-query-를-작성한다">1. long_query_time 이상으로 실행되는 쿼리에 대하여, slow_query_log_file 에 존재하는 파일에 slow query 를 작성한다.</h3>
<ul>
  <li>long_query_time (default : 10) - <a href="\\&quot;http://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_long_query_time\\&quot;">http://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_long_query_time</a>
    <ul>
      <li>OLTP 환경에서 해당값을 10초로 두는것은 개인적으로 너무 길다. 해당 값을 1초 혹은 2초로 수정하자.</li>
    </ul>
  </li>
  <li>slow_query_log_file (default : host_name-slow.log) - <a href="\\&quot;http://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_slow_query_log_file\\&quot;">http://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_slow_query_log_file</a></li>
</ul>

<h3 id="2-index-를-사용하지-않는-쿼리들">2. Index 를 사용하지 않는 쿼리들</h3>
<ul>
  <li>log_queries_not_using_indexes (default : OFF) - <a href="\\&quot;http://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_log_queries_not_using_indexes\\&quot;">http://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_log_queries_not_using_indexes</a>
    <ul>
      <li>해당옵션을 ON 하게 된다면, INDEX를 사용하지 않는 쿼리가 찍히게 된다. 이는 기존의 slow query (느려서 찍히게 되는 경우) 와 꼬일 수 있으므로, 프로젝트가 오픈되기 전 쿼리 검증을 위해 사용할 수 있다.</li>
      <li>중간에 쿼리튜닝을 위해 사용해야 한다면, 아래와 같이 사용하자.</li>
    </ul>
  </li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; set global log_queries_not_using_indexes = ON, GLOBAL long_query_time = 100000, GLOBAL slow_query_log_file = \'not_using_index.log\';
mysql&gt; flush logs; 정보 수집을 한 후, 원래의 값으로 돌려놓자.
mysql&gt; set global log_queries_not_using_indexes = OFF, GLOBAL long_query_time = 2, GLOBAL slow_query_log_file = \'host_name-slow.log\';
mysql&gt; flush logs;
</code></pre></div></div>

<ul>
  <li>물론 performance_schema 를 사용한다면, performance_schema.events_statements_summary_by_digest 의 SUM_NO_INDEX_USED 컬럼을 참고하여, 쿼리를 알아낼 수도 있다.</li>
</ul>

<h3 id="3-admin-관련-명령어-혹은-slave-의-sql_thread-에-의해-실행된-명령어중-long_query_time-이상으로-실행된-명령어를-찾는다">3. Admin 관련 명령어 혹은 slave 의 sql_thread 에 의해 실행된 명령어중 long_query_time 이상으로 실행된 명령어를 찾는다.</h3>
<ul>
  <li>log_slow_admin_statements (default : OFF) - <a href="\\&quot;http://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_log_slow_admin_statements\\&quot;">http://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_log_slow_admin_statements</a></li>
  <li>log_slow_slave_statements (default : OFF) - <a href="\\&quot;http://dev.mysql.com/doc/refman/5.6/en/replication-options-slave.html#sysvar_log_slow_slave_statements\\&quot;">http://dev.mysql.com/doc/refman/5.6/en/replication-options-slave.html#sysvar_log_slow_slave_statements</a>
    <ul>
      <li>기본적으로 slow queries 에는 admin 관련 명령어나 slave 의 sql_thread 에 의해 실행된 명령어는 아무리 오래걸려도 찍히지 않는다. 해당 내용을 확인하기 위해서는 위의 두옵션을 ON 으로 설정해야 한다.</li>
      <li>admin 관련 명령어 는 ALTER TABLE, ANALYZE TABLE, CHECK TABLE, CREATE INDEX, DROP INDEX, OPTIMIZE TABLE, REPAIR TABLE 이다. 예전에 alter table 을 누가했는지 알 수 있는 방법을 문의한적이 있다. 이때 해당 방법은 좋은 선택이 될 수 있다. 물론 해당 명령어 역시, long_query_time 이상으로 실행된 명령어에 대해서만 찍힌다.</li>
      <li>예제</li>
    </ul>
  </li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># User@Host: root[root] @  [192.168.74.202]  Id:    17
# Query_time: 3.362235  Lock_time: 0.007825 Rows_sent: 0  Rows_examined: 0
SET timestamp=1469352147;
alter table tester add index b(b);
</code></pre></div></div>

<h2 id="효율적으로-활용하기">효율적으로 활용하기</h2>

<h3 id="1-long-query-time-과-mysqldumpslow를-이용하여-쿼리의-종류와-횟수-계산하기">1. long-query-time 과 mysqldumpslow를 이용하여, 쿼리의 종류와 횟수 계산하기</h3>
<ul>
  <li>일반적으로 어떤 쿼리가 얼만큼 들어오는지 확인하기 위해 여러방법이 쓰일 수 있다. WAS에서 계산해볼 수도 있고, general log 를 내려 모든 쿼리를 확인할 수 있다. 하지만 이 경우 직접 통계를 내는 프로그램이 필요하다.</li>
  <li>간단히 특정시간동안 long_query_time 를 0 으로 세팅하여 모든 쿼리를 slow query에 남긴후, mysqldumpslow 를 통해 분석해 낼 수 있다.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; set global long_query_time=0;
shell# mysqldumpslow -s c slow-queries.log &gt; static.sql
</code></pre></div></div>

<ul>
  <li>mysqldumpslow 는 여러가지 옵션이 있으니 적절히 사용해 보자. <a href="\\&quot;https://dev.mysql.com/doc/refman/5.6/en/mysqldumpslow.html\\&quot;">https://dev.mysql.com/doc/refman/5.6/en/mysqldumpslow.html</a></li>
</ul>

<h3 id="2-min_examined_row_limit-를-이용하여-특정-row-이상으로-검사한-쿼리만-찾기">2. min_examined_row_limit 를 이용하여, 특정 row 이상으로 검사한 쿼리만 찾기.</h3>
<ul>
  <li>비록, log_queries_not_using_indexes 를 통해 index 를 사용하지 않는 쿼리를 찾는다 하더라도, 테이블에 데이터가 10건정도라면 인덱스를 타지 않는것이 현명한 쿼리일 수 있다. 또한 적절히 limit 를 쓴 경우도 그러하다. 이러한 쿼리들을 걸러내기 위하여 min_examined_row_limit 라는 변수가 존재한다.</li>
  <li>min_examined_row_limit (default : 0) - <a href="\\&quot;http://dev.mysql.com/doc/refman/5.6/en/server-options.html#option_mysqld_min-examined-row-limit\\&quot;">http://dev.mysql.com/doc/refman/5.6/en/server-options.html#option_mysqld_min-examined-row-limit</a></li>
  <li>소스를 보면 알겠지만, 해당 값은 마지막에 and 조건으로 연산이 된다. 해당 의미는 min_examined_row_limit 설정된값 이하로 row수를 검사하면 조건에 만족하더라도 slow query에 쓰지 않는다는 의미이다. 이로써 해당값으로 filter 를 만들 수 있다.(예를 들면 log_queries_not_using_indexes = ON, min_examined_row_limit=100)</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (thd-&gt;enable_slow_log)
{
  ulonglong end_utime_of_query= thd-&gt;current_utime();
  thd_proc_info(thd, 'logging slow query');

  if (((thd-&gt;server_status &amp; SERVER_QUERY_WAS_SLOW) ||
       ((thd-&gt;server_status &amp;
         (SERVER_QUERY_NO_INDEX_USED | SERVER_QUERY_NO_GOOD_INDEX_USED)) &amp;&amp;
        opt_log_queries_not_using_indexes &amp;&amp;
         !(sql_command_flags[thd-&gt;lex-&gt;sql_command] &amp; CF_STATUS_COMMAND))) &amp;&amp; thd-&gt;examined_row_count &gt;= thd-&gt;variables.min_examined_row_limit)
  {
    thd_proc_info(thd, 'logging slow query');
    thd-&gt;status_var.long_query_count++;
    slow_log_print(thd, thd-&gt;query(), thd-&gt;query_length(),
                   end_utime_of_query);
  }
}
</code></pre></div></div>

<h3 id="추천하는-설정">추천하는 설정</h3>

<ul>
  <li>MASTER</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[mysqld]
log-slow-queries=/log/slow_queries.log
long-query-time=1
log_slow_admin_statements
</code></pre></div></div>

<ul>
  <li>SLAVE</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[mysqld]
log-slow-queries=/log/slow_queries.log
long-query-time=1
log_slow_slave_statements
</code></pre></div></div>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'minsql'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="http://localhost:4000/blog/PostgreSQL-synchronous_commit-%EA%B0%9C%EB%85%90%EB%8F%84/" class="btn" title="PostgreSQL synchronous_commit 개념도">Previous</a>
      
      
        <a href="http://localhost:4000/blog/semi-synchronous-replication-on-mysql/" class="btn" title="Semi-Synchronous Replication on MySQL">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>&copy; 2018 MINSQL<!--. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.--></span>
<div class="social-icons">
	
	
	
	
	
	
	
	
	
  
	
  <a href="http://localhost:4000/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = 'http://localhost:4000';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>




</body>
</html>
