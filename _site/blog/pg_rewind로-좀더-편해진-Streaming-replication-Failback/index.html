<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>pg_rewind로 좀더 편해진 Streaming replication Failback &#8211; MINSQL</title>
<meta name="description" content="pg_rewind로 좀더 편해진 Streaming replication Failback

">
<meta name="keywords" content="Postgres">


<!-- Twitter Cards -->
<meta name="twitter:title" content="pg_rewind로 좀더 편해진 Streaming replication Failback">
<meta name="twitter:description" content="pg_rewind로 좀더 편해진 Streaming replication Failback

">



<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:4000/images/postgres.png">

<!-- Open Graph -->
<meta property="og:locale" content="ko_KR">
<meta property="og:type" content="article">
<meta property="og:title" content="pg_rewind로 좀더 편해진 Streaming replication Failback">
<meta property="og:description" content="pg_rewind로 좀더 편해진 Streaming replication Failback

">
<meta property="og:url" content="http://localhost:4000/blog/pg_rewind%EB%A1%9C-%EC%A2%80%EB%8D%94-%ED%8E%B8%ED%95%B4%EC%A7%84-Streaming-replication-Failback/">
<meta property="og:site_name" content="MINSQL">





<link rel="canonical" href="http://localhost:4000/blog/pg_rewind%EB%A1%9C-%EC%A2%80%EB%8D%94-%ED%8E%B8%ED%95%B4%EC%A7%84-Streaming-replication-Failback/">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="MINSQL Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="http://localhost:4000/assets/js/vendor/html5shiv.min.js"></script>
  <script src="http://localhost:4000/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		    <li><a href="http://localhost:4000/about/" >About</a></li>
		  
		    
		    <li><a href="http://localhost:4000/blog/" >Blog</a></li>
		  
		    
		    <li><a href="http://localhost:4000/tags/" >Tags</a></li>
		  
		    
		    <li><a href="http://localhost:4000/search/" >Search</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->


<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="entry">
    
  <!--  <img src="http://localhost:4000/images/postgres.png" class="entry-feature-image" alt="pg_rewind로 좀더 편해진 Streaming replication Failback" >-->
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="http://localhost:4000/tags/#Postgres" title="Pages tagged Postgres">Postgres</a></li>
        </ul>
        
          <h1 class="entry-title">pg_rewind로 좀더 편해진 Streaming replication Failback</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="http://localhost:4000/images/fabmichaela-photo.jpg" class="bio-photo" alt="MIN KIM bio photo"/>
        
        <span class="author vcard">By <span class="fn">MIN KIM</span></span>
        <span class="entry-date date published"><time datetime="2016-06-10T00:00:00+09:00"><i class="fa fa-calendar-o"></i> June 10, 2016</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        
        

        

          <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-cog"></i> My Table of Contents</h4></header>
              <ul class="toc__menu">
  <li><a href="#pg_rewind">pg_rewind</a></li>
  <li><a href="#test">TEST</a></li>
</ul>
            </nav>

        
      </footer>
      <div class="entry-content">
        <h1 id="pg_rewind로-좀더-편해진-streaming-replication-failback">pg_rewind로 좀더 편해진 Streaming replication Failback</h1>

<h3 id="pg_rewind">pg_rewind</h3>

<ul>
  <li>9.5부터 지원되는 feature이다.</li>
  <li>streaming replication을 사용하다가 마스터가 failure난 경우, 쉽게 슬레이브를 promote하여 서비스를 계속할수 있다. 그럼 마스터를 정상화시킨후 다시 replication의 slave로 failback할수 있는가? 디스크 폴드가 아니라서 크래시 직전까지의 데이터가 온전히 있는 경우에도 백업본 올려서 replication 재구성해야했다. 그 작업이 pg_rewind을 사용해서 단축될수 있다. pg_rewind는 소스디렉터라와 타겟디렉터리의 파일들을 sync해주는 유틸리티이다. pg_controlfile의 정보를 바탕으로 모든 data file을 동기화하는것이다. pg_rewind로 파일 싱크한뒤 recovery.conf작성하여 start하면 recovery모드로 진입해서 wal 적용하고 streaming 받기 시작한다.</li>
</ul>

<h3 id="test">TEST</h3>

<h4 id="i-streaming-replication-구성">I. streaming replication 구성</h4>

<h5 id="1-server1-준비">1. server1 준비</h5>

<div class="highlighter-rouge"><pre class="highlight"><code>./bin/initdb --pgdata=/data1/9.5/data -W
</code></pre>
</div>

<h5 id="2-server1-postgresqlconf">2. server1 postgresql.conf</h5>

<div class="highlighter-rouge"><pre class="highlight"><code>listen_addresses = '*'          # what IP address(es) to listen on;
port = 5435                             # (change requires restart)
wal_level = hot_standby                 # minimal, archive, hot_standby, or logical
wal_log_hints = on                      # also do full page writes of non-critical updates
archive_mode = on               # enables archiving; off, on, or always
archive_command = 'test ! -f /backup1/9.5/pg_arc/%f &amp;&amp; cp %p /backup1/9.5/pg_arc/%f'            # command to use to archive a logfile segment
max_wal_senders = 3             # max number of walsender processes
wal_keep_segments = 64          # in logfile segments, 16MB each; 0 disables
hot_standby = on                        # "on" allows queries during recovery
logging_collector = on          # Enable capturing of stderr and csvlog
</code></pre>
</div>

<h5 id="3-server1-pg_hbaconf">3. server1 pg_hba.conf</h5>

<div class="highlighter-rouge"><pre class="highlight"><code>host    replication     postgres        ::1/128                 trust
</code></pre>
</div>

<h5 id="4-server1-start">4. server1 start</h5>

<div class="highlighter-rouge"><pre class="highlight"><code>pg_ctl -D /data1/9.5/data start
</code></pre>
</div>

<h5 id="5-server2-준비">5. server2 준비</h5>

<div class="highlighter-rouge"><pre class="highlight"><code>pg_basebackup  -D /data1/9.5s1/data --xlog --progress --verbose -h localhost -p 5435
</code></pre>
</div>

<h5 id="6-server2-postgresqlconf">6. server2 postgresql.conf</h5>

<div class="highlighter-rouge"><pre class="highlight"><code>listen_addresses = '*'          # what IP address(es) to listen on;
port = 5445                             # (change requires restart)
wal_level = hot_standby                 # minimal, archive, hot_standby, or logical
wal_log_hints = on                      # also do full page writes of non-critical updates
archive_mode = on               # enables archiving; off, on, or always
archive_command = 'test ! -f /backup1/9.5s1/pg_arc/%f &amp;&amp; cp %p /backup1/9.5s1/pg_arc/%f'                # command to use to archive a logfile segment
max_wal_senders = 3             # max number of walsender processes
wal_keep_segments = 64          # in logfile segments, 16MB each; 0 disables
hot_standby = on                        # "on" allows queries during recovery
logging_collector = on          # Enable capturing of stderr and csvlog
</code></pre>
</div>

<h5 id="7-server2-pg_hbaconf">7. server2 pg_hba.conf</h5>

<div class="highlighter-rouge"><pre class="highlight"><code>host    replication     postgres        ::1/128                 trust
</code></pre>
</div>

<h5 id="8-server2-recoveryconf">8. server2 recovery.conf</h5>

<div class="highlighter-rouge"><pre class="highlight"><code>standby_mode = 'on'
primary_conninfo = 'host=localhost port=5435'
restore_command = 'cp /backup1/9.5/pg_arc/%f %p'
recovery_target_timeline = 'latest'
trigger_file = '/tmp/trigger_file_0'
</code></pre>
</div>

<h4 id="ii-failover-테스트">II. failover 테스트</h4>

<ul>
  <li>server1(port=5435) -&gt; server2(port=5445)</li>
</ul>

<h5 id="1-master-failover하자">1. master failover하자</h5>

<div class="highlighter-rouge"><pre class="highlight"><code>@server 1
touch /tmp/trigger_file_0
@server2
tail -f pg_log/postgresql-2016-06-10_123437.log
pgbench -i -s 10 postgres
</code></pre>
</div>

<h5 id="2-pg_rewind-테스트">2. pg_rewind 테스트</h5>

<div class="highlighter-rouge"><pre class="highlight"><code>@server1
[postgres@pgvm1 data]$ pg_ctl stop
waiting for server to shut down.... done
server stopped

[postgres@pgvm1 data]$ pg_rewind --source-server='host=::1 port=5445 user=postgres' --target-pgdata=$PGDATA -P
connected to server
servers diverged at WAL position 0/220003E0 on timeline 5
rewinding from last common checkpoint at 0/22000338 on timeline 5
reading source file list
reading target file list
reading WAL in target
need to copy 458 MB (total source directory size is 482 MB)
469734/469734 kB (100%) copied
creating backup label and updating control file
Done!
</code></pre>
</div>

<h5 id="3-recoveryconf-생성">3. recovery.conf 생성</h5>

<ul>
  <li>pg_rewind가 recovery.conf생성해주진 않는다</li>
  <li>server2꺼 recovery.done sync된것이 있으니 이걸 활용해서 변경</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>[postgres@pgvm1 data]$ cp recovery.done recovery.conf
[postgres@pgvm1 data]$ vi recovery.conf
standby_mode = 'on'
primary_conninfo = 'host=localhost port=5445'
restore_command = 'cp /backup1/9.5s1/pg_arc/%f %p'
recovery_target_timeline = 'latest'
trigger_file = '/tmp/trigger_file_0'
</code></pre>
</div>

<h5 id="4-postgresqlconf-변경">4. postgresql.conf 변경</h5>

<ul>
  <li>pg_rewind가 postgresql.conf를 덮어쓴다 변경해야할 파라메터들은 변경하자</li>
  <li>내경우엔 port랑 archive command</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>[postgres@pgvm1 data]$ vi postgresql.conf
listen_addresses = '*'          # what IP address(es) to listen on;
port = 5435                             # (change requires restart)
wal_level = hot_standby                 # minimal, archive, hot_standby, or logical
wal_log_hints = on                      # also do full page writes of non-critical updates
archive_mode = on               # enables archiving; off, on, or always
archive_command = 'test ! -f /backup1/9.5/pg_arc/%f &amp;&amp; cp %p /backup1/9.5/pg_arc/%f'            # command to use to archive a logfile segment
max_wal_senders = 3             # max number of walsender processes
wal_keep_segments = 64          # in logfile segments, 16MB each; 0 disables
hot_standby = on                        # "on" allows queries during recovery
logging_collector = on          # Enable capturing of stderr and csvlog
</code></pre>
</div>

<h5 id="5-failback">5. failback</h5>

<div class="highlighter-rouge"><pre class="highlight"><code>[postgres@pgvm1 data]$ pg_ctl start
server starting
</code></pre>
</div>

<h5 id="6-failback-확인">6. failback 확인</h5>

<div class="highlighter-rouge"><pre class="highlight"><code>@server1(new slave)
#pg_log/로그파일 확인
LOG:  database system was interrupted while in recovery at log time 2016-06-10 12:35:31 GMT-10
HINT:  If this has occurred more than once some data might be corrupted and you might need to choose an earlier recovery target.
cp: cannot stat `/backup1/9.5s1/pg_arc/00000007.history': No such file or directory
LOG:  entering standby mode
LOG:  restored log file "00000006.history" from archive
LOG:  restored log file "000000060000000000000022" from archive
cp: cannot stat `/backup1/9.5s1/pg_arc/00000005.history': No such file or directory
LOG:  redo starts at 0/22000300
LOG:  restored log file "000000060000000000000023" from archive
LOG:  restored log file "000000060000000000000024" from archive
LOG:  restored log file "000000060000000000000025" from archive
LOG:  restored log file "000000060000000000000026" from archive
LOG:  restored log file "000000060000000000000027" from archive
LOG:  restored log file "000000060000000000000028" from archive
cp: cannot stat `/backup1/9.5s1/pg_arc/000000060000000000000029': No such file or directory
LOG:  consistent recovery state reached at 0/29B41898
LOG:  database system is ready to accept read only connections
LOG:  invalid record length at 0/29B41898
LOG:  started streaming WAL from primary at 0/29000000 on timeline 6

@server2(new master)
[postgres@pgvm1 data]$ psql
Timing is on.
psql (9.5.1)
Type "help" for help.

postgres=# select * from pg_stat_replication ;
 pid  | usesysid | usename  | application_name | client_addr | client_hostname | client_port |         backend_start         | backend_xmin |   state   | sent_l ocation | write_location | flush_location | replay_location | sync_priority | sync_state
------+----------+----------+------------------+-------------+-----------------+ -------------+-------------------------------+--------------+-----------+------- --------+----------------+----------------+-----------------+---------------+------------
 2692 |       10 | postgres | wal_receiver1    | ::1         |                 | 48059 | 2016-06-10 12:39:21.203712+10 |              | streaming | 0/29B4 2588    | 0/29B42588     | 0/29B42588     | 0/29B418C8      |             0 | async
(1 row)

Time: 6.919 ms
postgres=#
</code></pre>
</div>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'minsql'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="http://localhost:4000/blog/skip-name-resolve-%EC%99%80-unauthenticated-user/" class="btn" title="skip-name-resolve 와 unauthenticated user">Previous</a>
      
      
        <a href="http://localhost:4000/blog/pgbadger%EB%A1%9C-PostgreSQL-%EB%A1%9C%EA%B7%B8%EB%B6%84%EC%84%9D%EB%A0%88%ED%8F%AC%ED%8C%85%ED%95%98%EA%B8%B0/" class="btn" title="pgbadger로 PostgreSQL 로그분석레포팅하기">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>&copy; 2018 MINSQL<!--. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.--></span>
<div class="social-icons">
	
	
	
	
	
	
	
	
	
  
	
  <a href="http://localhost:4000/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = 'http://localhost:4000';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>




</body>
</html>
