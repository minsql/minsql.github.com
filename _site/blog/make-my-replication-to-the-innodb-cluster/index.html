<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Make my replication to the InnoDB Cluster &#8211; MINSQL</title>
<meta name="description" content="Make my replication to the InnoDB Cluster

">
<meta name="keywords" content="MySQL">


<!-- Twitter Cards -->
<meta name="twitter:title" content="Make my replication to the InnoDB Cluster">
<meta name="twitter:description" content="Make my replication to the InnoDB Cluster

">



<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:4000/images/mysql.png">

<!-- Open Graph -->
<meta property="og:locale" content="ko_KR">
<meta property="og:type" content="article">
<meta property="og:title" content="Make my replication to the InnoDB Cluster">
<meta property="og:description" content="Make my replication to the InnoDB Cluster

">
<meta property="og:url" content="http://localhost:4000/blog/make-my-replication-to-the-innodb-cluster/">
<meta property="og:site_name" content="MINSQL">





<link rel="canonical" href="http://localhost:4000/blog/make-my-replication-to-the-innodb-cluster/">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="MINSQL Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="http://localhost:4000/assets/js/vendor/html5shiv.min.js"></script>
  <script src="http://localhost:4000/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">

<!-- Ads -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-2669792816970567",
    enable_page_level_ads: true
  });
</script>

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		    <li><a href="http://localhost:4000/about/" >About</a></li>
		  
		    
		    <li><a href="http://localhost:4000/blog/" >Blog</a></li>
		  
		    
		    <li><a href="http://localhost:4000/tags/" >Tags</a></li>
		  
		    
		    <li><a href="http://localhost:4000/search/" >Search</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->


<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="entry">
    
  <!--  <img src="http://localhost:4000/images/mysql.png" class="entry-feature-image" alt="Make my replication to the InnoDB Cluster" >-->
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="http://localhost:4000/tags/#MySQL" title="Pages tagged MySQL">MySQL</a></li>
        </ul>
        
          <h1 class="entry-title">Make my replication to the InnoDB Cluster</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="http://localhost:4000/images/fabmichaela-photo.jpg" class="bio-photo" alt="MIN KIM bio photo"/>
        
        <span class="author vcard">By <span class="fn">MIN KIM</span></span>
        <span class="entry-date date published"><time datetime="2017-09-19T00:00:00+09:00"><i class="fa fa-calendar-o"></i> September 19, 2017</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        
        

        

          <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-cog"></i> My Table of Contents</h4></header>
              <ul class="toc__menu">
  <li><a href="#innodb-cluster-requirements">InnoDB cluster Requirements</a></li>
  <li><a href="#methods-of-installing">Methods of Installing</a></li>
  <li><a href="#production-deployment">Production Deployment</a>
    <ul>
      <li><a href="#create-user">Create user</a></li>
      <li><a href="#working-with-mysqlsh">working with mysqlsh</a></li>
      <li><a href="#checking-instance-state">Checking Instance State</a></li>
      <li><a href="#creating-the-cluster">Creating the Cluster</a></li>
      <li><a href="#check-cluster-status">Check cluster status</a></li>
      <li><a href="#deploy-mysql-router">Deploy MySQL Router</a></li>
    </ul>
  </li>
</ul>
            </nav>

        
      </footer>
      <div class="entry-content">
        <h1 id="make-my-replication-to-the-innodb-cluster">Make my replication to the InnoDB Cluster</h1>

<p>내 리플리케이션을 cluster로 관리해보자. 빈서버를 cluster로 구성하는 것도 유사한 스텝으로 작업한다. 데이터가 있는 경우라면, cluster생성시 첫 인스턴스를 master를 선택하면 된다. 이데이터가 seed가 되어 전체 클러스터에 복제되게 된다.</p>

<blockquote>
  <p>이번 테스트에서는 기존 5.7에 설치된 mixed replication으로 구성한 서버들을 활용한다.(server1,2,3) 기존의 replication 모두 절체. reset slave, reset master</p>
</blockquote>

<h2 id="innodb-cluster-requirements">InnoDB cluster Requirements</h2>

<ul>
  <li>
    <p>InnoDB cluster uses Group Replication and therefore your server instances must meet the same requirements. See Section 17.7.1, “Group Replication Requirements”. -&gt; Requirements를 모두 만족하는지 확인한다.</p>
  </li>
  <li>
    <p>In addition, the provisioning scripts that MySQL Shell uses to configure servers for use in InnoDB cluster require access to Python (2.7 and above). On Windows MySQL Shell includes Python and no user configuration is required. On Unix Python must be found as part of the environment. To check that your system has Python configured correctly issue: -&gt; 그리고 python이 2.7 이상이 필요하다.</p>
  </li>
</ul>

<p>@all servers</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[root@server1:~]# git clone https://github.com/pyenv/pyenv.git ~/.pyenv
Initialized empty Git repository in /root/.pyenv/.git/
remote: Counting objects: 15428, done.
remote: Compressing objects: 100% (36/36), done.
remote: Total 15428 (delta 18), reused 31 (delta 10), pack-reused 15381
Receiving objects: 100% (15428/15428), 2.77 MiB | 820 KiB/s, done.
Resolving deltas: 100% (10543/10543), done.
[root@server1:~]# echo 'export PYENV_ROOT="$HOME/.pyenv"' &gt;&gt; ~/.bash_profile
[root@server1:~]# echo 'export PATH="$PYENV_ROOT/bin:$PATH"' &gt;&gt; ~/.bash_profile
[root@server1:~]# echo 'eval "$(pyenv init -)"' &gt;&gt; ~/.bash_profile
[root@server1:~]# pyenv versions
* system (set by /root/.pyenv/version)
[root@server1:~]# pyenv install 2.7.13
Downloading Python-2.7.13.tar.xz...
-&gt; https://www.python.org/ftp/python/2.7.13/Python-2.7.13.tar.xz
Installing Python-2.7.13...
Installed Python-2.7.13 to /root/.pyenv/versions/2.7.13

[root@server1:~]# python --version
Python 2.6.6
[root@server1:~]# pyenv versions
* system (set by /root/.pyenv/version)
  2.7.13
[root@server1:~]# cd /mysql

[root@server1:/mysql]# pyenv local 2.7.13
[root@server1:/mysql]# python --version
Python 2.7.13
</code></pre>
</div>

<h2 id="methods-of-installing">Methods of Installing</h2>

<ul>
  <li>MySQL Server 5.7.17 or higher. For details, see Chapter 2, Installing and Upgrading MySQL. -&gt; ok</li>
  <li>MySQL Shell 1.0.9 or higher. For details, see Section 19.3.1, “Installing MySQL Shell”.
    <ul>
      <li>Installing MySQL Shell from Direct Downloads from the MySQL Developer Zone</li>
      <li>mysql-shell-1.0.10-linux-glibc2.12-x86-64bit.tar.gz 를 받아서 all servers에 업로드</li>
    </ul>
  </li>
  <li>MySQL Router 2.1.3 or higher. For details, see Installation.
    <ul>
      <li>Download official MySQL packages: Downloads are available at http://dev.mysql.com/downloads/router.</li>
      <li>mysql-router-2.1.4-linux-glibc2.12-x86-64bit.tar.gz 를 받아서 all servers에 업로드
@all servers</li>
    </ul>
  </li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>[root@server1:/mysql]# tar zxf mysql-shell-1.0.10-linux-glibc2.12-x86-64bit.tar.gz
[root@server1:/mysql]# tar zxf mysql-router-2.1.4-linux-glibc2.12-x86-64bit.tar.gz
cd /usr/local/bin
ln -s  /mysql/mysql-shell-1.0.10-linux-glibc2.12-x86-64bit/bin/mysqlsh /usr/local/bin/mysqlsh
ln -s  /mysql/mysql-router-2.1.4-linux-glibc2.12-x86-64bit/bin/mysqlrouter /usr/local/bin/mysqlrouter
</code></pre>
</div>

<h2 id="production-deployment">Production Deployment</h2>

<ul>
  <li>https://dev.mysql.com/doc/refman/5.7/en/mysql-innodb-cluster-working-with-production-deployment.html</li>
</ul>

<h3 id="create-user">Create user</h3>

<ul>
  <li>instance 관리를 위한 user account가 필요하다. root일 필요는 없다. 하지만 많은 권한을 가져야한다. SUPER포함..
    <ul>
      <li>The user account used to administer an instance does not have to be the root account, however the user needs to be assigned full read and write privileges on the Metadata tables in addition to full MySQL administrator privileges (SUPER, GRANT OPTION, CREATE, DROP and so on). To give the user your_user the privileges needed to administer InnoDB cluster issue:</li>
    </ul>
  </li>
  <li>grgr@ip 유저를 활용한다.</li>
</ul>

<p>@all servers</p>

<div class="highlighter-rouge"><pre class="highlight"><code>SET SQL_LOG_BIN=0;
create user 'grgr'@'192.168.73.123' identified by 'grgr';

GRANT ALL PRIVILEGES ON mysql_innodb_cluster_metadata.* TO grgr@'192.168.73.123' WITH GRANT OPTION;
GRANT RELOAD, SHUTDOWN, PROCESS, FILE, SUPER, REPLICATION SLAVE, REPLICATION CLIENT, CREATE USER ON *.* TO grgr@'192.168.73.123' WITH GRANT OPTION;
GRANT SELECT ON performance_schema.* TO grgr@'192.168.73.123' WITH GRANT OPTION;
GRANT SELECT ON sys.* TO grgr@'192.168.73.123' WITH GRANT OPTION;
GRANT SELECT, INSERT, UPDATE, DELETE ON mysql.* TO grgr@'192.168.73.123' WITH GRANT OPTION;

create user 'grgr'@'192.168.81.192' identified by 'grgr';
GRANT ALL PRIVILEGES ON mysql_innodb_cluster_metadata.* TO grgr@'192.168.81.192' WITH GRANT OPTION;
GRANT RELOAD, SHUTDOWN, PROCESS, FILE, SUPER, REPLICATION SLAVE, REPLICATION CLIENT, CREATE USER ON *.* TO grgr@'192.168.81.192' WITH GRANT OPTION;
GRANT SELECT ON performance_schema.* TO grgr@'192.168.81.192' WITH GRANT OPTION;
GRANT SELECT ON sys.* TO grgr@'192.168.81.192' WITH GRANT OPTION;
GRANT SELECT, INSERT, UPDATE, DELETE ON mysql.* TO grgr@'192.168.81.192' WITH GRANT OPTION;
SET SQL_LOG_BIN=1;
</code></pre>
</div>

<ul>
  <li>위처럼 멤버의 모든 아이피를 넣어줘야하지만, 유연한 변경을 위해서 %를 사용한다.</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>SET SQL_LOG_BIN=0;
create user 'grgr'@'192.168.%' identified by 'grgr';
GRANT ALL PRIVILEGES ON mysql_innodb_cluster_metadata.* TO grgr@'192.168.%' WITH GRANT OPTION;
GRANT RELOAD, SHUTDOWN, PROCESS, FILE, SUPER, REPLICATION SLAVE, REPLICATION CLIENT, CREATE USER ON *.* TO grgr@'192.168.%' WITH GRANT OPTION;
GRANT SELECT ON performance_schema.* TO grgr@'192.168.%' WITH GRANT OPTION;
GRANT SELECT ON sys.* TO grgr@'192.168.%' WITH GRANT OPTION;
GRANT SELECT, INSERT, UPDATE, DELETE ON mysql.* TO grgr@'192.168.%' WITH GRANT OPTION;
SET SQL_LOG_BIN=1;
</code></pre>
</div>

<ul>
  <li>
    <p>전체서버가 아직 클러스터 그룹이 되지 않은 상태이기 때문에, 모든 서버에 따로 변경을 가하는 경우에 SET SQL_LOG_BIN=0;을 잊지 않도록 한다. 나중에 dup에러를 만나지 않기 위해서. 물론 첫 구성이니 reset master로 해결할 수 있겠지만, 귀찮아지기 싫다면 SET SQL_LOG_BIN=0;로 작업한다. &gt; 기존 사용하던 database가 추가되어있는 경우,</p>

    <ul>
      <li>Checking compliance of existing tables… FAIL
ERROR: 6 table(s) do not have a Primary Key or Primary Key Equivalent (non-null unique key).</li>
    </ul>
  </li>
</ul>

<p>위와 같은 에러를 만날 수 있다. PK가 모두 존재하더라도.. 이건 user가 해당 데이터베이스에 권한이 없기 때문이었다. 만약 database가 사용자데이터베이스를 사용중이라면 권한을 추가해야한다. <code class="highlighter-rouge">GRANT SELECT ON test.* TO grgr@'192.168.%' WITH GRANT OPTION;</code> or 여러개라면, 그리고 귀찮다면 <code class="highlighter-rouge">GRANT SELECT ON *.* TO grgr@'192.168.%' WITH GRANT OPTION;</code></p>

<h3 id="working-with-mysqlsh">working with mysqlsh</h3>

<ul>
  <li>
    <p>When working with a production deployment it is a good idea to configure verbose logging for MySQL Shell initially. This is helpful in finding and resolving any issues that may arise when you are preparing the server to work as part of InnoDB cluster. To start MySQL Shell with a verbose logging level type: -&gt; production에서 작업할때는 log-level을 높여서 작업하면 이슈를 찾기가 쉽다.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">shell&gt; mysqlsh --log-level=DEBUG3</code></p>
  </li>
  <li>
    <p>The log file is located in ~/.mysqlsh/mysqlsh.log for Unix-based systems. On Microsoft Windows systems it is located in %APPDATA%\MySQL\mysqlsh\mysqlsh.log. See Section 18.5, “MySQL Shell Application Log”.</p>
  </li>
</ul>

<h3 id="checking-instance-state">Checking Instance State</h3>
<ul>
  <li>대상 인스턴스가 cluster에 추가할 수 있는 상태인지 먼저 확인한다.</li>
</ul>

<h4 id="checking-instance-configuration">Checking Instance Configuration</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>[root@server1:~]# mysqlsh  --log-level=DEBUG3 --uri grgr@192.168.73.123:3306

mysql-js&gt; dba.checkInstanceConfiguration('grgr@192.168.73.123:3306')
Please provide the password for 'grgr@192.168.73.123:3306':
Validating instance...

The instance '192.168.73.123:3306' is not valid for Cluster usage.

The following issues were encountered:

 - 2 table(s) do not have a Primary Key or Primary Key Equivalent (non-null unique key).
 - Some configuration options need to be fixed.

+----------------------------------+---------------+----------------+--------------------------------------------------+
| Variable                         | Current Value | Required Value | Note     |
+----------------------------------+---------------+----------------+--------------------------------------------------+
| binlog_checksum                  | CRC32         | NONE           | Update the server variable or restart the server |
| binlog_format                    | MIXED         | ROW            | Update the server variable or restart the server |
| enforce_gtid_consistency         | OFF           | ON             | Restart the server     |
| gtid_mode                        | OFF           | ON             | Restart the server     |
| log_slave_updates                | 0             | ON             | Restart the server     |
| master_info_repository           | FILE          | TABLE          | Restart the server     |
| relay_log_info_repository        | FILE          | TABLE          | Restart the server     |
| transaction_write_set_extraction | OFF           | XXHASH64       | Restart the server     |
+----------------------------------+---------------+----------------+--------------------------------------------------+


Please fix these issues, restart the server and try again.

{
    "config_errors": [
        {
            "action": "server_update",
            "current": "CRC32",
            "option": "binlog_checksum",
            "required": "NONE"
        },
        {
            "action": "server_update",
            "current": "MIXED",
            "option": "binlog_format",
            "required": "ROW"
        },
        {
            "action": "restart",
            "current": "OFF",
            "option": "enforce_gtid_consistency",
            "required": "ON"
        },
        {
            "action": "restart",
            "current": "OFF",
            "option": "gtid_mode",
            "required": "ON"
        },
        {
            "action": "restart",
            "current": "0",
            "option": "log_slave_updates",
            "required": "ON"
        },
        {
            "action": "restart",
            "current": "FILE",
            "option": "master_info_repository",
            "required": "TABLE"
        },
        {
            "action": "restart",
            "current": "FILE",
            "option": "relay_log_info_repository",
            "required": "TABLE"
        },
        {
            "action": "restart",
            "current": "OFF",
            "option": "transaction_write_set_extraction",
            "required": "XXHASH64"
        }
    ],
    "errors": [
        "2 table(s) do not have a Primary Key or Primary Key Equivalent (non-null unique key)."
    ],
    "restart_required": true,
    "status": "error"
}
=&gt; my.cnf 변경하고 다시 시작.

mysql-js&gt;  dba.checkInstanceConfiguration('grgr@192.168.73.123:3306')
Please provide the password for 'grgr@192.168.73.123:3306':
Validating instance...

The instance '192.168.73.123:3306' is not valid for Cluster usage.

The following issues were encountered:

 - 2 table(s) do not have a Primary Key or Primary Key Equivalent (non-null unique key).

Please fix these issues and try again.

{
    "errors": [
        "2 table(s) do not have a Primary Key or Primary Key Equivalent (non-null unique key)."
    ],
    "restart_required": false,
    "status": "error"
}
mysql-js&gt;
=&gt; pk 없는 테이블은 추가해준다.

mysql-sql&gt; \js
Switching to JavaScript mode...
mysql-js&gt; dba.checkInstanceConfiguration('grgr@192.168.73.123:3306')
Please provide the password for 'grgr@192.168.73.123:3306':
Validating instance...

The instance '192.168.73.123:3306' is valid for Cluster usage
{
    "status": "ok"
}
mysql-js&gt;
=&gt; status가 ok 라면 계속 진행한다.
</code></pre>
</div>

<h3 id="creating-the-cluster">Creating the Cluster</h3>

<p><code class="highlighter-rouge">[root@server1:~]# mysqlsh --log-level=DEBUG3 --uri grgr@192.168.73.123:3306</code></p>

<ul>
  <li>Now create the cluster</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>mysql-js&gt; var cluster = dba.createCluster('myCluster');
A new InnoDB cluster will be created on instance 'grgr@192.168.73.123:3306'.

Creating InnoDB cluster 'myCluster' on 'grgr@192.168.73.123:3306'...
Adding Seed Instance...

Cluster successfully created. Use Cluster.addInstance() to add MySQL instances.
At least 3 instances are needed for the cluster to be able to withstand up to
one server failure.

mysql-js&gt;
</code></pre>
</div>

<ul>
  <li>check the instance state:</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>mysql-js&gt; cluster.checkInstanceState('grgr@192.168.73.123:3306')
Please provide the password for 'grgr@192.168.73.123:3306':
Analyzing the instance replication state...

The instance '192.168.73.123:3306' is valid for the cluster.
The instance is fully recoverable.

{
    "reason": "recoverable",
    "state": "ok"
}
</code></pre>
</div>

<ul>
  <li>Check the cluster status:</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>mysql-js&gt; cluster.status()
{
    "clusterName": "myCluster",
    "defaultReplicaSet": {
        "name": "default",
        "primary": "192.168.73.123:3306",
        "status": "OK_NO_TOLERANCE",
        "statusText": "Cluster is NOT tolerant to any failures.",
        "topology": {
            "192.168.73.123:3306": {
                "address": "192.168.73.123:3306",
                "mode": "R/W",
                "readReplicas": {},
                "role": "HA",
                "status": "ONLINE"
            }
        }
    }
}
mysql-js&gt;
</code></pre>
</div>

<h4 id="adding-instances">Adding instances</h4>
<p>You need to add two more instances to the cluster to make it tolerant to a server failure.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[root@server1:~]#  mysqlsh  --log-level=DEBUG3 --uri grgr@192.168.73.123:3306

mysql-js&gt; cluster=dba.getCluster();

mysql-js&gt; cluster.status();
</code></pre>
</div>

<ul>
  <li>다음과 같이 추가한다.</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>dba.checkInstanceConfiguration('grgr@192.168.81.192:3306')
cluster.addInstance("grgr@192.168.81.192:3306")
dba.checkInstanceConfiguration('grgr@192.168.85.198:3306')
cluster.addInstance("grgr@192.168.85.198:3306")
</code></pre>
</div>

<ul>
  <li>logs</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>Please provide the password for 'grgr@192.168.85.198:3306':
Validating instance...

The instance '192.168.85.198:3306' is valid for Cluster usage
{
    "status": "ok"
}
mysql-js&gt;
mysql-js&gt; cluster.addInstance('grgr@192.168.85.198:3306')
A new instance will be added to the InnoDB cluster. Depending on the amount of
data on the cluster this might take from a few seconds to several hours.

Please provide the password for 'grgr@192.168.85.198:3306':
Adding instance to the cluster ...

Cluster.addInstance: WARNING: Not running locally on the server and can not access its error log.
ERROR:
Group Replication join failed.
ERROR: Error joining instance to cluster: '192.168.85.198:3306' - Query failed.3092 (HY000): The server is not configured properly to be an active member of the group. Please see more details on error log.. Query: START group_replication (RuntimeError)

mysql-js&gt; cluster.addInstance("grgr@192.168.85.198:3306", {ipWhitelist: "192.168.73.0/24,192.168.81.0/24,192.168.85.0/24"})
A new instance will be added to the InnoDB cluster. Depending on the amount of
data on the cluster this might take from a few seconds to several hours.

Please provide the password for 'grgr@192.168.85.198:3306':
Adding instance to the cluster ...

The instance 'grgr@192.168.85.198:3306' was successfully added to the cluster.

mysql-js&gt;
</code></pre>
</div>

<p>=&gt; 잘 추가된다면 다행이지만..
역시 여러가지 에러케이스가 존재한다.
configuration다 변경했는지.
user를 잘 생성했는지.
PK를 다 추가했는지.
checkInstanceConfiguration에서 걸린 에러를 잘 확인하도록 한다.
정보가 부족하다면 dba.verbose = 1를 사용한다.</p>

<h4 id="error-cases">Error Cases</h4>

<ul>
  <li>User권한 부족</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>mysql-js&gt; dba.verbose = 1
1
mysql-js&gt; dba.checkInstanceConfiguration('grgr@192.168.81.192:3306')
Please provide the password for 'grgr@192.168.81.192:3306':
Validating instance...

=========================== MySQL Provision Output ===========================
Enter the password for server (grgr@192.168.81.192:3306):

Running check command.
Checking Group Replication prerequisites.
* Comparing options compatibility with Group Replication... PASS
Server configuration is compliant with the requirements.
* Checking server version... PASS
Server is 5.7.17

* Checking that server_id is unique... PASS
The server_id is valid.

* Checking compatibility of Multi-Threaded Slave settings... PASS
Multi-Threaded Slave settings are compatible with Group Replication.

* Checking compliance of existing tables... FAIL
ERROR: 6 table(s) do not have a Primary Key or Primary Key Equivalent (non-null unique key).
        PERCONA_SCHEMA.xtrabackup_history, test.events, test.t1, test.t2, test.tp, test_group_event_stats.event_user_actions

Group Replication requires tables to use InnoDB and have a PRIMARY KEY or PRIMARY KEY Equivalent (non-null unique key). Tables that do not follow these requirements will be readable but not updateable when used with Group Replication. If your applications make updates (INSERT, UPDATE or DELETE) to these tables, ensure they use the InnoDB storage engine and have a PRIMARY KEY or PRIMARY KEY Equivalent.
You can retry this command with the --allow-non-compatible-tables option if you'd like to enable Group Replication ignoring this warning.


ERROR: Error checking instance: The operation could not continue due to the following requirementsnot being met:
Non-compatible tables found in database.
==============================================================================
The instance '192.168.81.192:3306' is not valid for Cluster usage.

The following issues were encountered:

 - 6 table(s) do not have a Primary Key or Primary Key Equivalent (non-null unique key).

Please fix these issues and try again.

{
    "errors": [
        "6 table(s) do not have a Primary Key or Primary Key Equivalent (non-null unique key)."
    ],
    "restart_required": false,
    "status": "error"
}
mysql-js&gt;
</code></pre>
</div>
<p>=&gt; 추가된 데이터베이스에 권한이 없다. 권한을 부여
<code class="highlighter-rouge">GRANT SELECT ON *.* TO grgr@'192.168.73.123' WITH GRANT OPTION;</code></p>

<ul>
  <li>IP whitelist문제
    <ul>
      <li>addInstance에서 작업하다가 에러남. 이건 무엇인가 한참 해맸으나. IP 대역대 문제였음.</li>
      <li>mysql error log를 함께 본다</li>
    </ul>
  </li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>2017-09-19T12:09:08.639569+09:00 0 [Warning] Plugin group_replication reported: '[GCS] Connection attempt from IP address 192.168.81.192 refused. Address is not in the IP whitelist.'
</code></pre>
</div>

<p>=&gt; 이런 에러를 발견했다면 whitelist문제일수 있다. group_replication_ip_whitelist= AUTOMATIC 이지만, C class를 벗어난 대역대 간의 통신에 대해서는 수동으로 추가해줄 필요가 있음. 물론 서로간에 방화벽이나 SElinux같은 것이 활성화 되지 않은 통신이 가능한 상태의 서버들간이어야함.</p>

<p>@server1: group_replication_ip_whitelist를 설정한다.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>root@localhost:(none) 16:18:00&gt;stop group_replication;

Query OK, 0 rows affected (35.04 sec)

set global group_replication_ip_whitelist = '192.168.73.0/24,192.168.81.0/24,192.168.85.0/24';

set global group_replication_ip_whitelist=AUTOMATIC;


root@localhost:(none) 16:18:43&gt;start group_replication;
ERROR 3097 (HY000): The START GROUP_REPLICATION command failed as there was an error when joining the communication group.
=&gt; 노드가 1개뿐이었던 상태이므로 조인할수 없다는 에러가 나온다. 이렇게 되면,
mysql-js&gt; dba.rebootClusterFromCompleteOutage();
Reconfiguring the default cluster from complete outage...


The cluster was successfully rebooted.

&lt;Cluster:myCluster&gt;



 mysql-js&gt; cluster.addInstance("grgr@192.168.81.192:3306");
 A new instance will be added to the InnoDB cluster. Depending on the amount of
 data on the cluster this might take from a few seconds to several hours.

 Please provide the password for 'grgr@192.168.81.192:3306':
 Adding instance to the cluster ...

 The instance 'grgr@192.168.81.192:3306' was successfully added to the cluster.
=&gt; addInsatance 할때도 cluster.addInstance(“grgr@192.168.81.192:3306”, {ipWhitelist: “192.168.73.0/24,192.168.81.0/24,192.168.85.0/24”})와 같이 whitelist argument를 추가한다.
</code></pre>
</div>

<ul>
  <li>gtid에러
    <ul>
      <li>addInstance에서 실패하면 mysqlsh 의 로그보다는 mysql error log를 보는 것에 좋다.</li>
      <li>mysql error log를 함께 본다</li>
    </ul>
  </li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>2017-09-19T12:16:32.035765+09:00 0 [ERROR] Plugin group_replication reported: 'This member has more executed transactions than those present in the group. Local transactions: 998a1dbd-7b3c-11e7-a6c0-fa163ed51496:1 &gt; Group transactions: 7f3e956c-98f7-11e7-84a4-fa163e110d6b:1-159,
b5eafd39-2316-11e7-88c5-fa163e110d6b:1-24'
=&gt; 트랜잭션이 더 있었다? 지금은 설정하면서 발생한 트랜잭션일 가능성이 높으므로, reset master해버린다.

root@localhost:(none) 12:16:59&gt;reset master;
Query OK, 0 rows affected (0.00 sec)
</code></pre>
</div>

<h3 id="check-cluster-status">Check cluster status</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>[root@server1:~]#  mysqlsh  --log-level=DEBUG3 --uri grgr@192.168.73.123:3306

mysql-js&gt; cluster=dba.getCluster();

mysql-js&gt; cluster.status();
{
    "clusterName": "myCluster",
    "defaultReplicaSet": {
        "name": "default",
        "primary": "192.168.73.123:3306",
        "status": "OK",
        "statusText": "Cluster is ONLINE and can tolerate up to ONE failure.",
        "topology": {
            "192.168.73.123:3306": {
                "address": "192.168.73.123:3306",
                "mode": "R/W",
                "readReplicas": {},
                "role": "HA",
                "status": "ONLINE"
            },
            "192.168.81.192:3306": {
                "address": "192.168.81.192:3306",
                "mode": "R/O",
                "readReplicas": {},
                "role": "HA",
                "status": "ONLINE"
            },
            "192.168.85.198:3306": {
                "address": "192.168.85.198:3306",
                "mode": "R/O",
                "readReplicas": {},
                "role": "HA",
                "status": "ONLINE"
            }
        }
    }
}
</code></pre>
</div>

<h3 id="deploy-mysql-router">Deploy MySQL Router</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>[root@server1:~]# cd /mysql/mysql-router-2.1.4-linux-glibc2.12-x86-64bit
[root@server1:/mysql/mysql-router-2.1.4-linux-glibc2.12-x86-64bit]# cd bin
[root@server1:/mysql/mysql-router-2.1.4-linux-glibc2.12-x86-64bit/bin]#

[root@server1:/mysql/mysql-router-2.1.4-linux-glibc2.12-x86-64bit/bin]# mysqlrouter --bootstrap root@localhost:3306 --user=mysql
Please enter MySQL password for root:
WARNING: The MySQL server does not have SSL configured and metadata used by therouter may be transmitted unencrypted.

Bootstrapping system MySQL Router instance...
MySQL Router  has now been configured for the InnoDB cluster 'myCluster'.

The following connection information can be used to connect to the cluster.

Classic MySQL protocol connections to cluster 'myCluster':
- Read/Write Connections: localhost:6446
- Read/Only Connections: localhost:6447

X protocol connections to cluster 'myCluster':
- Read/Write Connections: localhost:64460
- Read/Only Connections: localhost:64470
[root@server1:/mysql/mysql-router-2.1.4-linux-glibc2.12-x86-64bit/bin]#
[root@server1:/mysql/mysql-router-2.1.4-linux-glibc2.12-x86-64bit/bin]# mysqlrouter &amp;
[1] 3225
Connect using Mysql Router
Read/Write Connections: localhost:6446
[root@server1:/mysql/mysql-router-2.1.4-linux-glibc2.12-x86-64bit/bin]# mysqlsh --uri test@localhost:6446
Creating a Session to 'test@localhost:6446'
Enter password:
Your MySQL connection id is 13101
Server version: 5.7.17-enterprise-commercial-advanced-log MySQL Enterprise Server - Advanced Edition (Commercial)
No default schema selected; type \use &lt;schema&gt; to set one.
MySQL Shell 1.0.10

Copyright (c) 2016, 2017, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type '\help' or '\?' for help; '\quit' to exit.

Currently in JavaScript mode. Use \sql to switch to SQL mode and execute queries.
mysql-js&gt; \sql
Switching to SQL mode... Commands end with ;
mysql-sql&gt; select @@hostname;
+-------------------------------+
| @@hostname                    |
+-------------------------------+
| server1 |
+-------------------------------+
1 row in set (0.00 sec)
mysql-sql&gt; \q
Bye!
Read/Only Connections: localhost:6447
[root@server1:/mysql/mysql-router-2.1.4-linux-glibc2.12-x86-64bit/bin]# mysqlsh --uri test@localhost:6447
Creating a Session to 'test@localhost:6447'
Enter password:
Your MySQL connection id is 116
Server version: 5.7.17-log MySQL Community Server (GPL)
No default schema selected; type \use &lt;schema&gt; to set one.
MySQL Shell 1.0.10

Copyright (c) 2016, 2017, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type '\help' or '\?' for help; '\quit' to exit.

Currently in JavaScript mode. Use \sql to switch to SQL mode and execute queries.
mysql-js&gt; \sql
Switching to SQL mode... Commands end with ;
mysql-sql&gt; select @@hostname;
+-------------------------------+
| @@hostname                    |
+-------------------------------+
| server3 |
+-------------------------------+
1 row in set (0.00 sec)
mysql-sql&gt;
</code></pre>
</div>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'minsql'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="http://localhost:4000/blog/MySQL-%ED%86%B5%EA%B3%84%EC%A0%95%EB%B3%B4/" class="btn" title="MySQL 통계정보">Previous</a>
      
      
        <a href="http://localhost:4000/blog/MySQL-sandbox-%EC%84%A4%EC%B9%98%EC%99%80-%EC%9D%B4%EC%9A%A9%EB%B0%A9%EB%B2%95/" class="btn" title="MySQL sandbox 설치와 이용방법">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    <div class="google-ads" style="margin:10px 0;">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- 320x50 ad -->
  <ins class="adsbygoogle"
       style="display:inline-block;width:320px;height:50px"
       data-ad-client="ca-pub-2669792816970567"
       data-ad-slot="6147132222"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div><!-- /.google-ads -->

<span>&copy; 2018 MINSQL<!--. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.--></span>
<div class="social-icons">
	
	
	
	
	
	
	
	<a href="https://github.com/minsql" title="MINSQL on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  
	
  <a href="http://localhost:4000/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = 'http://localhost:4000';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 'https://www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-56786998-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = 'https://stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



</body>
</html>
