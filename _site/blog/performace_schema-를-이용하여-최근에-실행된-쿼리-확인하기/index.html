<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>performace_schema 를 이용하여 최근에 실행된 쿼리 확인하기 &#8211; MINSQL</title>
<meta name="description" content="performace_schema 를 이용하여 최근에 실행된 쿼리 확인하기

">
<meta name="keywords" content="MySQL">


<!-- Twitter Cards -->
<meta name="twitter:title" content="performace_schema 를 이용하여 최근에 실행된 쿼리 확인하기">
<meta name="twitter:description" content="performace_schema 를 이용하여 최근에 실행된 쿼리 확인하기

">



<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:4000/images/mysql.png">

<!-- Open Graph -->
<meta property="og:locale" content="ko_KR">
<meta property="og:type" content="article">
<meta property="og:title" content="performace_schema 를 이용하여 최근에 실행된 쿼리 확인하기">
<meta property="og:description" content="performace_schema 를 이용하여 최근에 실행된 쿼리 확인하기

">
<meta property="og:url" content="http://localhost:4000/blog/performace_schema-%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%98%EC%97%AC-%EC%B5%9C%EA%B7%BC%EC%97%90-%EC%8B%A4%ED%96%89%EB%90%9C-%EC%BF%BC%EB%A6%AC-%ED%99%95%EC%9D%B8%ED%95%98%EA%B8%B0/">
<meta property="og:site_name" content="MINSQL">





<link rel="canonical" href="http://localhost:4000/blog/performace_schema-%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%98%EC%97%AC-%EC%B5%9C%EA%B7%BC%EC%97%90-%EC%8B%A4%ED%96%89%EB%90%9C-%EC%BF%BC%EB%A6%AC-%ED%99%95%EC%9D%B8%ED%95%98%EA%B8%B0/">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="MINSQL Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="http://localhost:4000/assets/js/vendor/html5shiv.min.js"></script>
  <script src="http://localhost:4000/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		    <li><a href="http://localhost:4000/about/" >About</a></li>
		  
		    
		    <li><a href="http://localhost:4000/blog/" >Blog</a></li>
		  
		    
		    <li><a href="http://localhost:4000/tags/" >Tags</a></li>
		  
		    
		    <li><a href="http://localhost:4000/search/" >Search</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->


<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="entry">
    
  <!--  <img src="http://localhost:4000/images/mysql.png" class="entry-feature-image" alt="performace_schema 를 이용하여 최근에 실행된 쿼리 확인하기" >-->
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="http://localhost:4000/tags/#MySQL" title="Pages tagged MySQL">MySQL</a></li>
        </ul>
        
          <h1 class="entry-title">performace_schema 를 이용하여 최근에 실행된 쿼리 확인하기</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="http://localhost:4000/images/makayal-photo.jpg" class="bio-photo" alt="MIN CHO bio photo"/>
        
        <span class="author vcard">By <span class="fn">MIN CHO</span></span>
        <span class="entry-date date published"><time datetime="2016-02-01T00:00:00+09:00"><i class="fa fa-calendar-o"></i> February 01, 2016</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        
        

        

          <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-cog"></i> My Table of Contents</h4></header>
              
            </nav>

        
      </footer>
      <div class="entry-content">
        <h1 id="performace_schema-를-이용하여-최근에-실행된-쿼리-확인하기">performace_schema 를 이용하여 최근에 실행된 쿼리 확인하기</h1>

<p>show processlist 와 show engine processlist 를 확인하면, 어떤 쿼리인지는 알 수 없으나 트랜잭션을 잡고 있는것을 확인할 수 있습니다. commit 되지 않은 트랜잭션이 존재한다면, MySQL InnoDB는 old image를 읽어오기 위해 시간이 지날수록 느려지고 다른 쿼리또한 lock 으로 인해 대기될 수 있습니다. 해당 쿼리를 tracking 하기 위해서는 기본적으로 performace_schema 가 ON (1) 되어 있어야 합니다. MySQL 5.6.6 이상에서는 은 기본적으로 해당값이 ON 되어 있으므로, 추가적인 설정이 필요없습니다. <a href="http://dev.mysql.com/doc/refman/5.6/en/performance-schema-system-variables.html#sysvar_performance_schema">http://dev.mysql.com/doc/refman/5.6/en/performance-schema-system-variables.html#sysvar_performance_schema</a></p>

<div class="highlighter-rouge"><pre class="highlight"><code>    mysql&gt; show global variables like 'performance_schema';
    +--------------------+-------+
    | Variable_name      | Value |
    +--------------------+-------+
    | performance_schema | ON    |
    +--------------------+-------+
    1 row in set (0.00 sec)
</code></pre>
</div>

<p>먼저 예제를 하나 만들도록 하겠습니다. session 1 에서 테이블을 만들고, 해당 테이블에 값을 넣습니다.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Session 1&gt;
    mysql&gt; create table p ( a int);
    Query OK, 0 rows affected (0.03 sec)

    mysql&gt; begin;
    Query OK, 0 rows affected (0.00 sec)

    mysql&gt; insert into p values (1);
    Query OK, 1 row affected (0.00 sec)
</code></pre>
</div>

<p>다른 세션에서 show engine innodb status, show processlist;, information_schema.INNODB_TRX 를 조회해 보겠습니다.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Session 2&gt;
    mysql&gt; show engine innodb statusG
    ------------
    TRANSACTIONS
    ------------
    Trx id counter 632685
    Purge done for trx's n:o &lt; 632684 undo n:o &lt; 0 state: running but idle
    History list length 443
    LIST OF TRANSACTIONS FOR EACH SESSION:
    ---TRANSACTION 0, not started
    MySQL thread id 53587, OS thread handle 0x7f6f0c0a2700, query id 498268 localhost root init
    show engine innodb status
    ---TRANSACTION 0, not started
    MySQL thread id 15918, OS thread handle 0x7f6eec0ed700, query id 498176 localhost gu cleaning up
    ---TRANSACTION 632684, ACTIVE 32 sec
/* 해당 transaction 이 Active 상태로 32초동안 active 상태지만, 어떤 쿼리인지는 알 수 없습니다. 단순히 test.p 테이블에 실행된 쿼리로만 짐작이 됩니다.
현재는 아무런 쿼리도 돌고 있지 않기 때문입니다. 물론 undo log entires 를 통해 DML이 실행되었을것이라고 짐작할 수 있습니다.
undo log entries 가 없는 경우도 있는데, 이는 begin; select .... 구문을 실행했기 때문입니다.
commit 이나 rollback 이 오랬동안 이루어지지 않았다면, 이또한 성능정하를 일이키는 요소입니다.
**/
    1 lock struct(s), heap size 360, 0 row lock(s), undo log entries 1
    sMySQL thread id 56604, OS thread handle 0x7f6f0c061700, query id 497985 localhost root cleaning up
    TABLE LOCK table `test`.`p` trx id 632684 lock mode IX



    mysql&gt; show processlist;
    +-------+------+-----------+-------+---------+------+-------+------------------+
    | Id    | User | Host      | db    | Command | Time | State | Info             |
    +-------+------+-----------+-------+---------+------+-------+------------------+
    | 15918 | gu   | localhost | mysql | Sleep   |   24 |       | NULL             |
    | 53587 | root | localhost | NULL  | Query   |    0 | init  | show processlist |
    | 56604 | root | localhost | test  | Sleep   |   42 |       | NULL             |
    +-------+------+-----------+-------+---------+------+-------+------------------+
    5 rows in set (0.00 sec)

/* show processlist; 에서는 현재 해당 thread가 아무런 작업을 하고 있지 않기 때문에 Sleep 상태만을 보여줍니다.**/

    mysql&gt; select * from information_schema.INNODB_TRXG
    *************************** 1. row ***************************
                trx_id: 632684
             trx_state: RUNNING
               trx_started: 2016-01-26 04:22:10
         trx_requested_lock_id: NULL
          trx_wait_started: NULL
            trx_weight: 2
           trx_mysql_thread_id: 56604
             trx_query: NULL
           trx_operation_state: NULL
         trx_tables_in_use: 0
         trx_tables_locked: 0
          trx_lock_structs: 1
         trx_lock_memory_bytes: 360
           trx_rows_locked: 0
         trx_rows_modified: 1
       trx_concurrency_tickets: 0
           trx_isolation_level: REPEATABLE READ
         trx_unique_checks: 1
        trx_foreign_key_checks: 1
    trx_last_foreign_key_error: NULL
     trx_adaptive_hash_latched: 0
     trx_adaptive_hash_timeout: 10000
          trx_is_read_only: 0
    trx_autocommit_non_locking: 0
    1 row in set (0.00 sec)

/* information_schema.INNODB_TRX 에서는 현재 해당 thread가 아무런 작업을 하고 있지 않기 때문에 trx_rows_modified 를 통해 어떤 DML 이 실행되었고, 1개의 record를 수정한채 commit 하지 않았다는것만을 알 수 있습니다. **/
</code></pre>
</div>

<p>performance_schema.events_statements_current 의 데이터를 조회해 보겠습니다. 해당 테이블은 마지막에 해당 thread에서 실행된 쿼리를 저장하고 있습니다. 해당 테이블의 값을 조회하기 위해서는 performance_schema.threads 와 조인이 필요합니다. processlist 에서 보여주는 mysql 이 만든 thread와 performance_schema 에서 만든 thread 값이 다르기 때문입니다. (performance_schema.threads 는 background thread의 값도 가지고 있기 때문입니다.)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Session 2&gt;
    mysql&gt; SELECT esc.THREAD_ID, t.processlist_id, esc.SQL_TEXT FROM performance_schema.events_statements_current esc JOIN performance_schema.threads t ON t.thread_id = esc.thread_id WHERE t.processlist_id = 56604;
    +-----------+----------------+--------------------------+
    | THREAD_ID | processlist_id | SQL_TEXT                 |
    +-----------+----------------+--------------------------+
    |     56624 |          56604 | insert into p values (1) |
    +-----------+----------------+--------------------------+

/* process_id 가 56604 의 thread 가 실행한 마지막 쿼리가 나타납니다. 56604 값은 show engine innodb statusG 의 transaction 값 중 thread id 56604 값을 통해 알아낼 수 있습니다. **/
</code></pre>
</div>

<p>위는 default 로 동작되는 방법입니다. 그렇다면, 지나간 쿼리에 대해서는 어떻게 로그인을 하는지 확인해보겠습니다. - https://dev.mysql.com/doc/refman/5.6/en/performance-schema-statement-tables.html 먼저 performance_schema.setup_consumers 테이블의 events_statements_history, events_statements_history_long 의 값을 ON 시켜주어야 합니다. (default 로 events_statements_current 는 ON이 되어 있는것을 확인할 수 있습니다.)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    mysql&gt; select * from performance_schema.setup_consumers where name like 'events_statements_%';
    +--------------------------------+---------+
    | NAME                           | ENABLED |
    +--------------------------------+---------+
    | events_statements_current      | YES     |
    | events_statements_history      | NO      |
    | events_statements_history_long | NO      |
    +--------------------------------+---------+
    3 rows in set (0.00 sec)


    mysql&gt; UPDATE performance_schema.setup_consumers SET ENABLED = 'YES' WHERE name like 'events_statements_%';
    Query OK, 2 row affected (0.06 sec)
    Rows matched: 3  Changed: 2  Warnings: 0
</code></pre>
</div>

<p>다시 session 1에서 쿼리를 실행해 보겠습니다.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">Session</span> <span class="mi">1</span><span class="o">&gt;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">p</span><span class="p">;</span>
<span class="o">+</span><span class="c1">------+</span>
<span class="o">|</span> <span class="n">a</span>    <span class="o">|</span>
<span class="o">+</span><span class="c1">------+</span>
<span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">------+</span>
<span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">p</span> <span class="k">where</span> <span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="o">+</span><span class="c1">------+</span>
<span class="o">|</span> <span class="n">a</span>    <span class="o">|</span>
<span class="o">+</span><span class="c1">------+</span>
<span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">------+</span>
<span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">p</span> <span class="k">where</span> <span class="n">a</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">Empty</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
</code></pre>
</div>

<p>다른 세션에서 events_statements_history_long 의 값을 조회하여 해당세션이 실행한 쿼리들을 확인할 수 있습니다.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span>
    <span class="n">esh</span><span class="p">.</span><span class="n">THREAD_ID</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">processlist_id</span><span class="p">,</span> <span class="n">esh</span><span class="p">.</span><span class="n">SQL_TEXT</span>
<span class="k">FROM</span>
    <span class="n">performance_schema</span><span class="p">.</span><span class="n">events_statements_history_long</span> <span class="n">esh</span>
        <span class="k">JOIN</span>
    <span class="n">performance_schema</span><span class="p">.</span><span class="n">threads</span> <span class="n">t</span> <span class="k">ON</span> <span class="n">t</span><span class="p">.</span><span class="n">thread_id</span> <span class="o">=</span> <span class="n">esh</span><span class="p">.</span><span class="n">thread_id</span>
<span class="k">WHERE</span>
    <span class="n">t</span><span class="p">.</span><span class="n">processlist_id</span> <span class="o">=</span> <span class="mi">56604</span> <span class="k">order</span> <span class="k">by</span> <span class="n">TIMER_END</span> <span class="k">ASC</span><span class="p">;</span>

<span class="o">+</span><span class="c1">-----------+----------------+---------------------------+</span>
<span class="o">|</span> <span class="n">THREAD_ID</span> <span class="o">|</span> <span class="n">processlist_id</span> <span class="o">|</span> <span class="n">SQL_TEXT</span>                  <span class="o">|</span>
<span class="o">+</span><span class="c1">-----------+----------------+---------------------------+</span>
<span class="o">|</span>     <span class="mi">56624</span> <span class="o">|</span>          <span class="mi">56604</span> <span class="o">|</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">p</span>           <span class="o">|</span>
<span class="o">|</span>     <span class="mi">56624</span> <span class="o">|</span>          <span class="mi">56604</span> <span class="o">|</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">p</span> <span class="k">where</span> <span class="n">a</span><span class="o">=</span><span class="mi">1</span> <span class="o">|</span>
<span class="o">|</span>     <span class="mi">56624</span> <span class="o">|</span>          <span class="mi">56604</span> <span class="o">|</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">p</span> <span class="k">where</span> <span class="n">a</span><span class="o">=</span><span class="mi">0</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">-----------+----------------+---------------------------+</span>
<span class="mi">3</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
</code></pre>
</div>

<p>위와 같이 시간순으로 조회될 수 있습니다. 전체 쿼리를 저장할 수 있는 갯수는 아래의 설정을 통해 가능합니다. (performance_schema_events_statements_history_size, performance_schema_events_statements_history_long_size)
5.6.6 이상부터는 default 값으로 MySQL 의 현재상태를 고려하여 값이 자동으로 늘어나거나 줄어들게 됩니다.
물론 아래의 값으로 고정시킬 수도 있습니다.</p>

<p>https://dev.mysql.com/doc/refman/5.6/en/performance-schema-system-variables.html#sysvar_performance_schema_events_statements_history_size
https://dev.mysql.com/doc/refman/5.6/en/performance-schema-system-variables.html#sysvar_performance_schema_events_statements_history_long_size</p>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'minsql'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="http://localhost:4000/blog/%EC%9C%A0%EC%9A%A9%ED%95%9C-mysql-client-tool-%EC%98%B5%EC%85%98/" class="btn" title="유용한 mysql client tool 옵션 (my.cnf 에 설정)">Previous</a>
      
      
        <a href="http://localhost:4000/blog/innodb_table_stats_not-found/" class="btn" title="Error Table "mysql"."innodb_table_stats" not found 는 왜 발생하는가?">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>&copy; 2018 MINSQL<!--. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.--></span>
<div class="social-icons">
	
	
	
	
	
	
	
	
	
  
	
  <a href="http://localhost:4000/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = 'http://localhost:4000';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>




</body>
</html>
