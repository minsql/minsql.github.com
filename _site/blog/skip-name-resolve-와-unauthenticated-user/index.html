<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>skip-name-resolve 와 unauthenticated user &#8211; MINSQL</title>
<meta name="description" content="skip-name-resolve 와 unauthenticated user

">
<meta name="keywords" content="MySQL">


<!-- Twitter Cards -->
<meta name="twitter:title" content="skip-name-resolve 와 unauthenticated user">
<meta name="twitter:description" content="skip-name-resolve 와 unauthenticated user

">



<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:4000/images/mysql.png">

<!-- Open Graph -->
<meta property="og:locale" content="ko_KR">
<meta property="og:type" content="article">
<meta property="og:title" content="skip-name-resolve 와 unauthenticated user">
<meta property="og:description" content="skip-name-resolve 와 unauthenticated user

">
<meta property="og:url" content="http://localhost:4000/blog/skip-name-resolve-%EC%99%80-unauthenticated-user/">
<meta property="og:site_name" content="MINSQL">





<link rel="canonical" href="http://localhost:4000/blog/skip-name-resolve-%EC%99%80-unauthenticated-user/">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="MINSQL Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="http://localhost:4000/assets/js/vendor/html5shiv.min.js"></script>
  <script src="http://localhost:4000/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		    <li><a href="http://localhost:4000/about/" >About</a></li>
		  
		    
		    <li><a href="http://localhost:4000/blog/" >Blog</a></li>
		  
		    
		    <li><a href="http://localhost:4000/tags/" >Tags</a></li>
		  
		    
		    <li><a href="http://localhost:4000/search/" >Search</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->


<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="entry">
    
  <!--  <img src="http://localhost:4000/images/mysql.png" class="entry-feature-image" alt="skip-name-resolve 와 unauthenticated user" >-->
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="http://localhost:4000/tags/#MySQL" title="Pages tagged MySQL">MySQL</a></li>
        </ul>
        
          <h1 class="entry-title">skip-name-resolve 와 unauthenticated user</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="http://localhost:4000/images/makayal-photo.jpg" class="bio-photo" alt="MIN CHO bio photo"/>
        
        <span class="author vcard">By <span class="fn">MIN CHO</span></span>
        <span class="entry-date date published"><time datetime="2016-04-18T00:00:00+09:00"><i class="fa fa-calendar-o"></i> April 18, 2016</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        
        

        

          <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-cog"></i> My Table of Contents</h4></header>
              <ul class="toc__menu">
  <li><a href="#문제발생">문제발생</a></li>
  <li><a href="#원인">원인</a></li>
  <li><a href="#문제-재현">문제 재현</a></li>
  <li><a href="#해결방법">해결방법</a></li>
</ul>
            </nav>

        
      </footer>
      <div class="entry-content">
        <h1 id="skip-name-resolve-와-unauthenticated-user">skip-name-resolve 와 unauthenticated user</h1>

<h2 id="문제발생">문제발생</h2>

<p>MySQL 을 사용하다보면, DNS 서버가 응답을 하지 않음으로서 MySQL 이 커넥션을 빠르게 처리하지 못하고 show processlist 에 많은 수의 ‘unauthenticated user’ 가 발생할 수 있다. 이는 error log 에 아래와 같이 나타나며,</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[Warning] IP address '192.168.74.202' could not be resolved: Temporary failure in name resolution
[Warning] IP address '192.168.74.202' could not be resolved: Name or service not known
</code></pre>
</div>

<p>porcesslist에는 다음과 같이 나타날 수 있다.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>+-----+----------------------+----------------------+--------------------+---------+------+-------+------------------+
| Id  | User                 | Host                 | db                 | Command | Time | State | Info             |
+-----+----------------------+----------------------+--------------------+---------+------+-------+------------------+
| 160 | unauthenticated user | 192.168.74.202:52305 | NULL               | Connect | NULL | login | NULL             |
+-----+----------------------+----------------------+--------------------+---------+------+-------+------------------+
</code></pre>
</div>

<h2 id="원인">원인</h2>

<p>MySQL 은 connection 에서 요청이 들어오면, DNS 를 확인하여 해당 host가 무엇인지를 확인한다. 비록 user 생성시에 hostname이 아닌 IP로 유저를 만들었다 할지라도 들어온 IP에 대해 look up을 하고 hostname 을 알아낸 다음 해당 정보를 다시 사용하거나 관리하기 위하여 performance_schema.host_cache 에 저장한다. 이 과정에서 DNS 서버가 문제가 생긴다면, hostname 을 알아오려는 문제때문에 접속시에 시간이 오래걸릴뿐 아니라 커넥션들이 쌓이며 문제가 발생할 수 있다. 만약 user를 단순히 IP 로서 지정하거나 IP 를 통해 접속을 한다면, skip-name-resolve 를 my.cnf 에 주어 오버헤드를 막을 수 있다.</p>

<h2 id="문제-재현">문제 재현</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>root@localhost:(none) 23:13:43&gt; show global variables like 'skip_name_resolve';
+-------------------+-------+
| Variable_name     | Value |
+-------------------+-------+
| skip_name_resolve | OFF   |
+-------------------+-------+
1 row in set (0.01 sec)


        [root@testvm2 cert]# time /db/5.6/bin/mysql -uau -pau --host="192.168.74.203" -e "select 1"
        Warning: Using a password on the command line interface can be insecure.
        +---+
        | 1 |
        +---+
        | 1 |
        +---+

        real    0m28.071s
        user    0m0.006s
        sys 0m0.013s
        ^^^ 접속시 대략 30초 정도의 시간이 걸렸다. DNS 를 lookup 했지만, 현재 DNS가 빨리 응답을 못하고 있다.


root@localhost:performance_schema 23:16:22&gt; show processlist;
+-----+----------------------+----------------------+--------------------+---------+------+-------+------------------+
| Id  | User                 | Host                 | db                 | Command | Time | State | Info             |
+-----+----------------------+----------------------+--------------------+---------+------+-------+------------------+
| 151 | root                 | localhost            | performance_schema | Query   |    0 | init  | show processlist |
| 160 | unauthenticated user | 192.168.74.202:52305 | NULL               | Connect | NULL | login | NULL             |
+-----+----------------------+----------------------+--------------------+---------+------+-------+------------------+
2 rows in set (0.00 sec)
^^^ 해당 순간의 processlist 이다.


root@localhost:performance_schema 23:18:58&gt; select * from performance_schema.host_cacheG
*************************** 1. row ***************************
                                        IP: 192.168.74.202
                                      HOST: NULL
                            HOST_VALIDATED: NO
                        SUM_CONNECT_ERRORS: 0
                 COUNT_HOST_BLOCKED_ERRORS: 0
           COUNT_NAMEINFO_TRANSIENT_ERRORS: 6
           COUNT_NAMEINFO_PERMANENT_ERRORS: 0
                       COUNT_FORMAT_ERRORS: 0
           COUNT_ADDRINFO_TRANSIENT_ERRORS: 0
           COUNT_ADDRINFO_PERMANENT_ERRORS: 0
                       COUNT_FCRDNS_ERRORS: 0
                     COUNT_HOST_ACL_ERRORS: 0
               COUNT_NO_AUTH_PLUGIN_ERRORS: 0
                  COUNT_AUTH_PLUGIN_ERRORS: 0
                    COUNT_HANDSHAKE_ERRORS: 0
                   COUNT_PROXY_USER_ERRORS: 0
               COUNT_PROXY_USER_ACL_ERRORS: 0
               COUNT_AUTHENTICATION_ERRORS: 0
                          COUNT_SSL_ERRORS: 0
         COUNT_MAX_USER_CONNECTIONS_ERRORS: 0
COUNT_MAX_USER_CONNECTIONS_PER_HOUR_ERRORS: 0
             COUNT_DEFAULT_DATABASE_ERRORS: 0
                 COUNT_INIT_CONNECT_ERRORS: 0
                        COUNT_LOCAL_ERRORS: 0
                      COUNT_UNKNOWN_ERRORS: 0
                                FIRST_SEEN: 2016-04-14 21:37:38
                                 LAST_SEEN: 2016-04-14 23:19:03
                          FIRST_ERROR_SEEN: 2016-04-14 21:37:38
                           LAST_ERROR_SEEN: 2016-04-14 23:19:03
1 row in set (0.00 sec)
^^^ host_cache 테이블에는 IP만 존재할 뿐 HOST는 NULL 로 되어있다. DNS로부터 HOST 값을 정확히 얻어내지 못했다. host_cache 에 HOST_VALIDATED 값이 NO 라면, 다음번 접속시에도 똑같이 느린 현상이 발생한다.
만약 제대로 HOST 값이 저장된다면, 해당 테이블이 truncate 되기 전까지는 빠른 접속이 가능하다.
    - https://dev.mysql.com/doc/refman/5.6/en/host-cache-table.html
</code></pre>
</div>

<p>Error log</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[Warning] IP address '192.168.74.202' could not be resolved: Temporary failure in name resolution
[Warning] IP address '192.168.74.202' could not be resolved: Name or service not known
^^^ error log 에 다음과 같이 찍힐 수 있다.
</code></pre>
</div>

<h2 id="해결방법">해결방법</h2>

<h4 id="1-hosts-파일에-추가">1. hosts 파일에 추가</h4>

<p>만약 DNS에서 자주 문제가 생긴다면, /etc/hosts 에 해당 서버로 접속하는 서버들에 대해 host를 명시해 줄 수 있다.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>[root@testvm3 certs]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.74.203  testvm3
192.168.74.202  testvm2

[root@testvm2 cert]# time /db/5.6/bin/mysql -uau -pau --host="192.168.74.203" -e "select 1"
Warning: Using a password on the command line interface can be insecure.
+---+
| 1 |
+---+
| 1 |
+---+

real    0m0.021s
user    0m0.003s
sys 0m0.009s
^^^ DNS를 lookup 하기 전에 /etc/hosts 파일에서 해당 hostname을 가지고 오기 때문에 아주 빠르다.

root@localhost:(none) 23:22:09&gt; select * from performance_schema.host_cacheG
*************************** 1. row ***************************
                                        IP: 192.168.74.202
                                      HOST: testvm2
                            HOST_VALIDATED: YES
                        SUM_CONNECT_ERRORS: 0
                 COUNT_HOST_BLOCKED_ERRORS: 0
           COUNT_NAMEINFO_TRANSIENT_ERRORS: 6
           COUNT_NAMEINFO_PERMANENT_ERRORS: 0
                       COUNT_FORMAT_ERRORS: 0
           COUNT_ADDRINFO_TRANSIENT_ERRORS: 0
           COUNT_ADDRINFO_PERMANENT_ERRORS: 0
                       COUNT_FCRDNS_ERRORS: 0
                     COUNT_HOST_ACL_ERRORS: 0
               COUNT_NO_AUTH_PLUGIN_ERRORS: 0
                  COUNT_AUTH_PLUGIN_ERRORS: 0
                    COUNT_HANDSHAKE_ERRORS: 0
                   COUNT_PROXY_USER_ERRORS: 0
               COUNT_PROXY_USER_ACL_ERRORS: 0
               COUNT_AUTHENTICATION_ERRORS: 0
                          COUNT_SSL_ERRORS: 0
         COUNT_MAX_USER_CONNECTIONS_ERRORS: 0
COUNT_MAX_USER_CONNECTIONS_PER_HOUR_ERRORS: 0
             COUNT_DEFAULT_DATABASE_ERRORS: 0
                 COUNT_INIT_CONNECT_ERRORS: 0
                        COUNT_LOCAL_ERRORS: 0
                      COUNT_UNKNOWN_ERRORS: 0
                                FIRST_SEEN: 2016-04-14 21:37:38
                                 LAST_SEEN: 2016-04-14 23:22:01
                          FIRST_ERROR_SEEN: 2016-04-14 21:37:38
                           LAST_ERROR_SEEN: 2016-04-14 23:19:03
1 row in set (0.00 sec)
^^^ host_cache 의 HOST 에도 testvm2 라고 저장된다.


root@localhost:(none) 23:22:36&gt; show processlist;
+-----+------+---------------+------+---------+------+-------+------------------+
| Id  | User | Host          | db   | Command | Time | State | Info             |
+-----+------+---------------+------+---------+------+-------+------------------+
| 167 | root | localhost     | NULL | Query   |    0 | init  | show processlist |
| 168 | au   | testvm2:52593 | NULL | Sleep   |    9 |       | NULL             |
+-----+------+---------------+------+---------+------+-------+------------------+
2 rows in set (0.00 sec)
</code></pre>
</div>

<h4 id="2-mycnf-의-mysqld-섹션에-skip_name_resolve-를-추가하고-restart">2. my.cnf 의 [mysqld] 섹션에 skip_name_resolve 를 추가하고 restart</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>root@localhost:(none) 23:24:56&gt; show global variables like 'skip_name_resolve';
+-------------------+-------+
| Variable_name     | Value |
+-------------------+-------+
| skip_name_resolve | ON    |
+-------------------+-------+
1 row in set (0.02 sec)

[root@testvm2 cert]# time /db/5.6/bin/mysql -uau -pau --host="192.168.74.203" -e "select 1"
Warning: Using a password on the command line interface can be insecure.
+---+
| 1 |
+---+
| 1 |
+---+

real    0m0.025s
user    0m0.009s
sys 0m0.010s
^^^ hostname 을 알아오려는 시도를 하지 않기 때문에 빠르다.

root@localhost:(none) 23:25:57&gt; show processlist;
+----+------+----------------------+------+---------+------+-------+------------------+
| Id | User | Host                 | db   | Command | Time | State | Info             |
+----+------+----------------------+------+---------+------+-------+------------------+
|  1 | root | localhost            | NULL | Query   |    0 | init  | show processlist |
| 26 | au   | 192.168.74.202:54301 | NULL | Sleep   |    4 |       | NULL             |
+----+------+----------------------+------+---------+------+-------+------------------+
2 rows in set (0.00 sec)
^^^ 만약 접속하게 된다면, hostname 대신 192.168.74.202 가 나타나는것이 관찰된다.


root@localhost:(none) 23:25:57&gt; select * from performance_schema.host_cacheG
Empty set (0.00 sec)
^^^ 물론 host_cache 테이블에는 아무것도 존재하지 않는다.
</code></pre>
</div>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'minsql'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="http://localhost:4000/blog/mysql-client-utility-%EC%99%80-A-%EC%98%B5%EC%85%98/" class="btn" title="mysql client utility 와 -A 옵션">Previous</a>
      
      
        <a href="http://localhost:4000/blog/pg_rewind%EB%A1%9C-%EC%A2%80%EB%8D%94-%ED%8E%B8%ED%95%B4%EC%A7%84-Streaming-replication-Failback/" class="btn" title="pg_rewind로 좀더 편해진 Streaming replication Failback">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>&copy; 2018 MINSQL<!--. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.--></span>
<div class="social-icons">
	
	
	
	
	
	
	
	<a href="https://github.com/minsql" title="MINSQL on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  
	
  <a href="http://localhost:4000/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = 'http://localhost:4000';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>




</body>
</html>
