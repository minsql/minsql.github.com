<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>MySQL Fabric &#8211; MINSQL</title>
<meta name="description" content="MySQL Fabric

">
<meta name="keywords" content="MySQL">


<!-- Twitter Cards -->
<meta name="twitter:title" content="MySQL Fabric">
<meta name="twitter:description" content="MySQL Fabric

">



<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:4000/images/mysql.png">

<!-- Open Graph -->
<meta property="og:locale" content="ko_KR">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL Fabric">
<meta property="og:description" content="MySQL Fabric

">
<meta property="og:url" content="http://localhost:4000/blog/mysql-fabric/">
<meta property="og:site_name" content="MINSQL">





<link rel="canonical" href="http://localhost:4000/blog/mysql-fabric/">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="MINSQL Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="http://localhost:4000/assets/js/vendor/html5shiv.min.js"></script>
  <script src="http://localhost:4000/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		    <li><a href="http://localhost:4000/about/" >About</a></li>
		  
		    
		    <li><a href="http://localhost:4000/blog/" >Blog</a></li>
		  
		    
		    <li><a href="http://localhost:4000/tags/" >Tags</a></li>
		  
		    
		    <li><a href="http://localhost:4000/search/" >Search</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->


<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="entry">
    
  <!--  <img src="http://localhost:4000/images/mysql.png" class="entry-feature-image" alt="MySQL Fabric" >-->
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="http://localhost:4000/tags/#MySQL" title="Pages tagged MySQL">MySQL</a></li>
        </ul>
        
          <h1 class="entry-title">MySQL Fabric</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="http://localhost:4000/images/fabmichaela-photo.jpg" class="bio-photo" alt="MIN KIM bio photo"/>
        
        <span class="author vcard">By <span class="fn">MIN KIM</span></span>
        <span class="entry-date date published"><time datetime="2015-01-15T00:00:00+09:00"><i class="fa fa-calendar-o"></i> January 15, 2015</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        
        

        

          <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-cog"></i> My Table of Contents</h4></header>
              <ul class="toc__menu">
  <li><a href="#1-소개">1. 소개</a>
    <ul>
      <li><a href="#11-fabric-prerequisites">1.1. Fabric Prerequisites</a></li>
      <li><a href="#12-fabric-concepts">1.2. Fabric Concepts</a></li>
    </ul>
  </li>
  <li><a href="#2-mysql-fabric의-설치와-구성">2. MySQL Fabric의 설치와 구성</a>
    <ul>
      <li><a href="#21-downloading-mysql-fabric">2.1. Downloading MySQL Fabric</a></li>
      <li><a href="#22-installing-mysql-fabric">2.2. Installing MySQL Fabric</a></li>
      <li><a href="#23-configuring-mysql-fabric">2.3. Configuring MySQL Fabric</a></li>
    </ul>
  </li>
  <li><a href="#3-quick-start-example">3. Quick start Example</a>
    <ul>
      <li><a href="#31-creating-a-high-availability-group">3.1 Creating a High-Availability Group</a></li>
      <li><a href="#313-add-nodes-to-my_group">3.1.3 add nodes to my_group</a></li>
      <li><a href="#314-show-information">3.1.4 show information</a></li>
      <li><a href="#315-promote-server">3.1.5 promote server</a></li>
    </ul>
  </li>
  <li><a href="#4-maintenance">4. maintenance</a>
    <ul>
      <li><a href="#41-slave-stop">4.1 slave stop</a></li>
      <li><a href="#42-master-stop">4.2 master stop</a></li>
    </ul>
  </li>
  <li><a href="#99-issue-handling">99. issue handling</a>
    <ul>
      <li><a href="#991-regarding-protocolmysql">99.1 regarding protocol.mysql</a></li>
      <li><a href="#992-same-uuid-when-cloning-mysql-instances">99.2 same UUID when cloning mysql instances</a></li>
    </ul>
  </li>
</ul>
            </nav>

        
      </footer>
      <div class="entry-content">
        <h1 id="mysql-fabric">MySQL Fabric</h1>

<blockquote>
  <p>MySQL 서버팜을 관리하는 시스템 MySQL sharding 이나 HA를 구현, 관리 가능</p>
</blockquote>

<h2 id="1-소개">1. 소개</h2>
<ul>
  <li>Fabric에 access할때 XML-FPC protocol을 사용하는 것이 좋다. application은 MySQL connector 확장 버전을 사용해야하는데 현재, Connector/Python와 Connector/J 가 지원한다. Fabric은 GTID가 enable된 MySQL server를 관리한다. GTID를 통해서 서버간 consistency를 체크하고 유지관리한다. 서버군은 high-availability group이라고 불리우고, 이들 서버들에 대한 정보는 별도의 MySQL instance에서 관리한다. 이 관리 서버 인스턴스는 ha group에 포함될수 없고, backing store라고 불리운다. Fabric은 Python으로 작성되었으며 mysqlfabric이라는 utility를 사용해서 Fabric과 통신한다.</li>
</ul>

<h3 id="11-fabric-prerequisites">1.1. Fabric Prerequisites</h3>

<table>
<thead>
<tr>
  <th>Prerequisite</th>
  <th>Version</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Fabric MySQL servers</td>
  <td>MySQL server 5.6.10 or later</td>
</tr>
<tr>
  <td>backing store</td>
  <td>MySQL server 5.6.x or later</td>
</tr>
<tr>
  <td>mysqlfabric utility</td>
  <td>Python 2 (2.6 or later) ubc0f Connector/Python 1.2.1 or later.</td>
</tr>
<tr>
  <td>application fabric-aware connector</td>
  <td>Connector/Python 1.2.1 or later ub610ub294 Connector/J 5.1.27 or latern1.2. Fabric Concepts</td>
</tr>
</tbody>
</table>

<h3 id="12-fabric-concepts">1.2. Fabric Concepts</h3>

<table>
<thead>
<tr>
  <th>CONCEPTS</th>
  <th>DESCRIPTION</th>
</tr>
</thead>
<tbody>
<tr>
  <td>high-availability group</td>
  <td>MySQL 서버군.</td>
</tr>
<tr>
  <td>group identifier</td>
  <td>group 이름</td>
</tr>
<tr>
  <td>global group</td>
  <td>모든 shard에 적용되어야하는 변경사항들을 저장 (??)stores all updates that must be propogated to all shards that are part of a sharding scheme.</td>
</tr>
<tr>
  <td>node or fabric node</td>
  <td>Fabric system의 구성원 인스턴스</td>
</tr>
<tr>
  <td>Sharding</td>
  <td>여러 서버로 데이터를 분배하는 Fabric feature</td>
</tr>
<tr>
  <td>shard</td>
  <td>table data segment나 horizontal partition을 의미</td>
</tr>
<tr>
  <td>Primary</td>
  <td>group member중 master로 지정된 노드를 의미. RW 가능</td>
</tr>
<tr>
  <td>Secondary</td>
  <td>group member중 switchover나 failover시 master를 대체할수 있는 candidate을 의미. RO 임.</td>
</tr>
</tbody>
</table>

<h2 id="2-mysql-fabric의-설치와-구성">2. MySQL Fabric의 설치와 구성</h2>
<ul>
  <li>MySQL Fabric을 사용하려면 MySQL 5.6.10이상의 MySQL server 여러대를 먼저 준비해야한다. 그중 하나는 backing store로 사용되어야하고 나머지는 Fabric group으로 지정한다. MySQL Fabric의 replication feature를 사용할 계획이라면 replication topology에 따라 master한대와 하나이상의 slave서버가 필요하다. sharding feature를 사용하려면 shard의 depth(segment 개수)만큼의 서버가 필요하다.</li>
</ul>

<h3 id="21-downloading-mysql-fabric">2.1. Downloading MySQL Fabric</h3>

<ul>
  <li>mysql utility : http://dev.mysql.com/downloads/tools/utilities/</li>
  <li>connector/python : http://dev.mysql.com/downloads/connector/python/</li>
</ul>

<h3 id="22-installing-mysql-fabric">2.2. Installing MySQL Fabric</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>[mysql@testvm1 mydba]$ tar zxf mysql-utilities-1.5.3.tar.gz
[mysql@testvm1 mydba]$ cd mysql-utilities-1.5.3
[mysql@testvm1 mysql-utilities-1.5.3]$ python ./setup.py build
[mysql@testvm1 mysql-utilities-1.5.3]$ su
Password:
[root@testvm1 mysql-utilities-1.5.3]# python ./setup.py install
[root@testvm1 mysql-utilities-1.5.3]# exit
exit
[mysql@testvm1 mydba]$ tar zxf mysql-connector-python-2.0.2.tar.gz
[mysql@testvm1 mydba]$ cd mysql-connector-python-2.0.2
[mysql@testvm1 mysql-connector-python-2.0.2]$ python ./setup.py build
[mysql@testvm1 mysql-connector-python-2.0.2]$ su
Password:
[root@testvm1 mysql-connector-python-2.0.2]# python ./setup.py install
[root@testvm1 mysql-connector-python-2.0.2]# exit
exit
</code></pre>
</div>

<h3 id="23-configuring-mysql-fabric">2.3. Configuring MySQL Fabric</h3>
<h4 id="231-create-a-mysql-user">2.3.1. Create a MySQL User</h4>
<ul>
  <li>backing store에 fabric user 생성 (testvm1)</li>
</ul>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'fabric'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'fabric'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">ON</span> <span class="n">fabric</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'fabric'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">;</span>
</code></pre>
</div>

<ul>
  <li>fabric group node에 fabric user 생성 (testvm2, testvm3) 이 유저로 replication 연결도 하기 때문에 서로 호스트에 대해서도 명시해야한다. 테스트에서는 편의상 subnet으로 명시하였다.</li>
</ul>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'fabric'</span><span class="o">@</span><span class="s1">'192.168.56.%'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'fabric'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'fabric'</span><span class="o">@</span><span class="s1">'192.168.56.%'</span><span class="p">;</span><span class="o">&lt;</span>
</code></pre>
</div>

<h4 id="232-configuration-file">2.3.2. Configuration File</h4>
<ul>
  <li>fabric.cfg 파일 작성</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>[DEFAULT]
prefix = /db/mysql
sysconfdir = /db/mysql/conf
logdir = /data1/mysql/log

[storage]
address = localhost:3306
user = fabric
password = fabric
database = fabric
auth_plugin = mysql_native_password
connection_timeout = 6
connection_attempts = 6
connection_delay = 1

[servers]
user = fabric
password =

[protocol.xmlrpc]
address = localhost:32274
threads = 5
user = admin
password =
disable_authentication = no
realm = MySQL Fabric
ssl_ca =
ssl_cert =
ssl_key =

[protocol.mysql]
address = localhost:32275
user = admin
password =

[executor]
executors = 5

[logging]
level = INFO
url = file:///data1/mysql/log/fabric.log

[sharding]
mysqldump_program = /db/mysql/bin/mysqldump
mysqlclient_program = /db/mysql/bin/mysql

[statistics]
prune_time = 3600

[failure_tracking]
notifications = 300
notification_clients = 50
notification_interval = 60
failover_interval = 0
detections = 3
detection_interval = 6
detection_timeout = 1
prune_time = 3600

[connector]
ttl = 1

[client]
password =
</code></pre>
</div>

<h4 id="233-setup-backing-store">2.3.3. Setup Backing Store</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>[mysql@testvm1 conf]$ mysqlfabric --config=/db/mysql/conf/fabric.cfg manage setup
 [INFO] 1418111991.571184 - MainThread - Initializing persister: user (fabric), server (localhost:3306), database (fabric).
 Finishing initial setup
 =======================
 Password for admin user is not yet set.
 Password for admin/xmlrpc:
 Repeat Password:
 Password set.
 Password set.
 No result returned
</code></pre>
</div>
<h4 id="234-start">2.3.4 Start</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>[mysql@testvm1 conf]$ mysqlfabric --config=/db/mysql/conf/fabric.cfg manage start --daemonize
</code></pre>
</div>
<h4 id="235-stop">2.3.5 Stop</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>[mysql@testvm1 conf]$ mysqlfabric --config=/db/mysql/conf/fabric.cfg manage stop
</code></pre>
</div>

<h2 id="3-quick-start-example">3. Quick start Example</h2>

<h3 id="31-creating-a-high-availability-group">3.1 Creating a High-Availability Group</h3>

<h4 id="311-group-node-configuration">3.1.1 Group node configuration</h4>

<ul>
  <li> required variables
    <ul>
      <li>gtid_mode = on</li>
      <li>enforce-gtid-consistency</li>
      <li>log-bin</li>
      <li>log-slave-updates</li>
    </ul>
  </li>
</ul>

<h4 id="312-create-my_group">3.1.2 Create my_group</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>[mysql@testvm1 mysql]$ mysqlfabric group create my_group
Password for admin:
Fabric UUID:  5ca1ab1e-a007-feed-f00d-cab3fe13249e
Time-To-Live: 1

                                uuid finished success result
------------------------------------ -------- ------- ------
3cd38b3f-9c08-4996-8c03-a85607fc8f00        1       1      1

state success          when                                                   description
----- ------- ------------- -------------------------------------------------------------
    3       2   1.41812e+09 Triggered by .
    4       2   1.41812e+09                             Executing action (_create_group).
    5       2   1.41812e+09                              Executed action (_create_group).
</code></pre>
</div>

<h3 id="313-add-nodes-to-my_group">3.1.3 add nodes to my_group</h3>

<div class="highlighter-rouge"><pre class="highlight"><code> [mysql@testvm1 mysql]$ mysqlfabric group add my_group testvm2:3306
Password for admin:
Fabric UUID:  5ca1ab1e-a007-feed-f00d-cab3fe13249e
Time-To-Live: 1

                                uuid finished success result
------------------------------------ -------- ------- ------
2686ccbf-d192-4116-91ef-ab7d94a3159e        1       1      1

state success          when                                                   description
----- ------- ------------- -------------------------------------------------------------
    3       2   1.41812e+09 Triggered by .
    4       2   1.41812e+09                               Executing action (_add_server).
    5       2   1.41812e+09                                Executed action (_add_server).


[mysql@testvm1 mysql]$ mysqlfabric group add my_group testvm3:3306
Password for admin:
Fabric UUID:  5ca1ab1e-a007-feed-f00d-cab3fe13249e
Time-To-Live: 1

                                uuid finished success result
------------------------------------ -------- ------- ------
ac4d18c6-dd60-4751-9fdd-405843785aad        1       1      1

state success          when                                                   description
----- ------- ------------- -------------------------------------------------------------
    3       2   1.41812e+09 Triggered by .
    4       2   1.41812e+09                               Executing action (_add_server).
    5       2   1.41812e+09                                Executed action (_add_server).

</code></pre>
</div>

<h3 id="314-show-information">3.1.4 show information</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>[mysql@testvm1 mysql]$ mysqlfabric group lookup_servers my_group
Password for admin:
Fabric UUID: 5ca1ab1e-a007-feed-f00d-cab3fe13249e
Time-To-Live: 1

server_uuid address status mode weight
------------------------------------ ------------ --------- --------- ------
43f777a0-7f4a-11e4-863b-08002713b36f testvm2:3306 SECONDARY READ_ONLY 1.0
7f5ba91e-81d1-11e4-96b7-0800273900a5 testvm3:3306 SECONDARY READ_ONLY 1.0
</code></pre>
</div>

<h3 id="315-promote-server">3.1.5 promote server</h3>
<p>한 서버를 master로 promote시켜준다.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[mysql@testvm1 mysql]$ mysqlfabric group promote my_group
Password for admin:
Fabric UUID:  5ca1ab1e-a007-feed-f00d-cab3fe13249e
Time-To-Live: 1

                                uuid finished success result
------------------------------------ -------- ------- ------
3fa9a519-67f7-4928-ab40-6fbb073a2515        1       1      1

state success          when                                                   description
----- ------- ------------- -------------------------------------------------------------
    3       2   1.41812e+09  Triggered by .
    4       2   1.41812e+09                      Executing action (_define_ha_operation).
    5       2   1.41812e+09                       Executed action (_define_ha_operation).
    3       2   1.41812e+09 Triggered by .
    4       2   1.41812e+09                      Executing action (_find_candidate_fail).
    5       2   1.41812e+09                       Executed action (_find_candidate_fail).
    3       2   1.41812e+09 Triggered by .
    4       2   1.41812e+09                     Executing action (_check_candidate_fail).
    5       2   1.41812e+09                      Executed action (_check_candidate_fail).
    3       2   1.41812e+09 Triggered by .
    4       2   1.41812e+09                          Executing action (_wait_slave_fail).
    5       2   1.41812e+09                           Executed action (_wait_slave_fail).
    3       2   1.41812e+09 Triggered by .
    4       2   1.41812e+09                      Executing action (_change_to_candidate).
    5       2   1.41812e+09                       Executed action (_change_to_candidate).


[mysql@testvm1 mysql]$ mysqlfabric group lookup_servers my_group
Password for admin:
Fabric UUID:  5ca1ab1e-a007-feed-f00d-cab3fe13249e
Time-To-Live: 1

                         server_uuid      address    status       mode weight
------------------------------------ ------------ --------- ---------- ------
43f777a0-7f4a-11e4-863b-08002713b36f testvm2:3306 SECONDARY  READ_ONLY    1.0
7f5ba91e-81d1-11e4-96b7-0800273900a5 testvm3:3306   PRIMARY READ_WRITE    1.0
</code></pre>
</div>

<p>다른서버가 master가 되도록 하려면, 다시 커맨드 수행하면 된다고 하는데
2개 있을때는 candidate을 elect하지 못하는듯 한다.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[mysql@testvm1 mysql]$ mysqlfabric group promote my_group
Password for admin:
Fabric UUID: 5ca1ab1e-a007-feed-f00d-cab3fe13249e
Time-To-Live: 1

GroupError: There is no valid candidate that can be automatically chosen in group (my_group). Please, choose one manually.
</code></pre>
</div>

<ul>
  <li>하나더 추가해서 테스트
    <ul>
      <li>
        <p>mysqlfabric group add my_group testvm4:3306
```
[mysql@testvm1 log]$ mysqlfabric group promote my_group
Password for admin:
Fabric UUID:  5ca1ab1e-a007-feed-f00d-cab3fe13249e
Time-To-Live: 1</p>

        <div class="highlighter-rouge"><pre class="highlight"><code>                        uuid finished success result ------------------------------------ -------- ------- ------ 2e5f16ed-1864-4598-9c31-f8c1e6dd4879        1       1      1
</code></pre>
        </div>
      </li>
    </ul>
  </li>
</ul>

<p>state success          when                                                   description
—– ——- ————- ————————————————————-
    3       2   1.41812e+09  Triggered by .
    4       2   1.41812e+09                      Executing action (_define_ha_operation).
    5       2   1.41812e+09                       Executed action (_define_ha_operation).
    3       2   1.41812e+09 Triggered by .
    4       2   1.41812e+09                    Executing action (_find_candidate_switch).
    5       2   1.41812e+09                     Executed action (_find_candidate_switch).
    3       2   1.41812e+09 Triggered by .
    4       2   1.41812e+09                   Executing action (_check_candidate_switch).
    5       2   1.41812e+09                    Executed action (_check_candidate_switch).
    3       2   1.41812e+09 Triggered by .
    4       2   1.41812e+09                       Executing action (_block_write_switch).
    5       2   1.41812e+09                        Executed action (_block_write_switch).
    3       2   1.41812e+09  Triggered by .
    4       2   1.41812e+09                       Executing action (_wait_slaves_switch).
    5       2   1.41812e+09                        Executed action (_wait_slaves_switch).
    3       2   1.41812e+09 Triggered by .
    4       2   1.41812e+09                      Executing action (_change_to_candidate).
    5       2   1.41812e+09                       Executed action (_change_to_candidate).</p>

<p>[mysql@testvm1 log]$ mysqlfabric group lookup_servers my_group
Password for admin:
Fabric UUID:  5ca1ab1e-a007-feed-f00d-cab3fe13249e
Time-To-Live: 1</p>

<div class="highlighter-rouge"><pre class="highlight"><code>                     server_uuid      address    status       mode weight ------------------------------------ ------------ --------- ---------- ------ 1c70d9dd-84e5-11e4-aac7-0800279a65c5 testvm4:3306 SECONDARY  READ_ONLY    1.0 43f777a0-7f4a-11e4-863b-08002713b36f testvm2:3306   PRIMARY READ_WRITE    1.0 7f5ba91e-81d1-11e4-96b7-0800273900a5 testvm3:3306 SECONDARY  READ_ONLY    1.0 ```
</code></pre>
</div>

<h2 id="4-maintenance">4. maintenance</h2>

<h3 id="41-slave-stop">4.1 slave stop</h3>

<p>slave server stop되면 FAULTY status됨.
다시 올려도 계속 FAULTY상태임.
이건 spare로 status바꿨다가 다시 secondary로 넣어줘야함.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[mysql@testvm1 conf]$ mysqlfabric --config=/db/mysql/conf/fabric.cfg group health my_group
Fabric UUID:  5ca1ab1e-a007-feed-f00d-cab3fe13249e
Time-To-Live: 1

                                uuid is_alive    status is_not_running is_not_configured io_not_running sql_not_running io_error sql_error
------------------------------------ -------- --------- -------------- ----------------- -------------- --------------- -------- ---------
1c70d9dd-84e5-11e4-aac7-0800279a65c5        1    FAULTY              0                 0              0               0    False     False
43f777a0-7f4a-11e4-863b-08002713b36f        1   PRIMARY              0                 0              0               0    False     False
7f5ba91e-81d1-11e4-96b7-0800273900a5        1 SECONDARY              0                 0              0               0    False     False

issue
-----


[mysql@testvm1 conf]$ mysqlfabric --config=/db/mysql/conf/fabric.cfg server set_status 1c70d9dd-84e5-11e4-aac7-0800279a65c5 SPARE
Fabric UUID:  5ca1ab1e-a007-feed-f00d-cab3fe13249e
Time-To-Live: 1

                                uuid finished success result
------------------------------------ -------- ------- ------
0df3d7d7-322a-40a5-9a7f-84f0f1a58fd8        1       1      1

state success          when                                                   description
----- ------- ------------- -------------------------------------------------------------
    3       2   1.41812e+09 Triggered by .
    4       2   1.41812e+09                        Executing action (_set_server_status).
    5       2   1.41812e+09                         Executed action (_set_server_status).


[mysql@testvm1 conf]$ mysqlfabric --config=/db/mysql/conf/fabric.cfg server set_status 1c70d9dd-84e5-11e4-aac7-0800279a65c5 SECONDARY
Fabric UUID:  5ca1ab1e-a007-feed-f00d-cab3fe13249e
Time-To-Live: 1

                                uuid finished success result
------------------------------------ -------- ------- ------
e0a96e70-d32e-4b39-8d36-5a3f1abb5edd        1       1      1

state success          when                                                   description
----- ------- ------------- -------------------------------------------------------------
    3       2   1.41812e+09 Triggered by .
    4       2   1.41812e+09                        Executing action (_set_server_status).
    5       2   1.41812e+09                         Executed action (_set_server_status).


[mysql@testvm1 conf]$ mysqlfabric --config=/db/mysql/conf/fabric.cfg group health my_group
Fabric UUID:  5ca1ab1e-a007-feed-f00d-cab3fe13249e
Time-To-Live: 1

                                uuid is_alive    status is_not_running is_not_configured io_not_running sql_not_running io_error sql_error
------------------------------------ -------- --------- -------------- ----------------- -------------- --------------- -------- ---------
1c70d9dd-84e5-11e4-aac7-0800279a65c5        1 SECONDARY              0                 0              0               0    False     False
43f777a0-7f4a-11e4-863b-08002713b36f        1   PRIMARY              0                 0              0               0    False     False
7f5ba91e-81d1-11e4-96b7-0800273900a5        1 SECONDARY              0                 0              0               0    False     False

issue
-----
</code></pre>
</div>

<h3 id="42-master-stop">4.2 master stop</h3>

<p>일단 failure detector를 activate시키자.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[mysql@testvm1 conf]$ mysqlfabric group activate my_group
Password for admin:
Fabric UUID:  5ca1ab1e-a007-feed-f00d-cab3fe13249e
Time-To-Live: 1

                                uuid finished success result
------------------------------------ -------- ------- ------
b9faf486-d2a5-4df3-aca2-84cc1d73e032        1       1      1

state success          when                                                   description
----- ------- ------------- -------------------------------------------------------------
    3       2   1.41812e+09 Triggered by .
    4       2   1.41812e+09                           Executing action (_activate_group).
    5       2   1.41812e+09                            Executed action (_activate_group).
master shutdown

[mysql@testvm1 conf]$ mysqlfabric --config=/db/mysql/conf/fabric.cfg group health my_group
Fabric UUID:  5ca1ab1e-a007-feed-f00d-cab3fe13249e
Time-To-Live: 1

                                uuid is_alive    status is_not_running is_not_configured io_not_running sql_not_running io_error sql_error
------------------------------------ -------- --------- -------------- ----------------- -------------- --------------- -------- ---------
1c70d9dd-84e5-11e4-aac7-0800279a65c5        1 SECONDARY              0                 0              0               0    False     False
43f777a0-7f4a-11e4-863b-08002713b36f        0    FAULTY              0                 0              0               0    False     False
7f5ba91e-81d1-11e4-96b7-0800273900a5        1   PRIMARY              0                 0              0               0    False     False

issue
-----
</code></pre>
</div>

<p>master는 faulty되고 다른 하나가 primary됨.</p>

<p>또 죽이면</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[mysql@testvm1 conf]$ mysqlfabric --config=/db/mysql/conf/fabric.cfg group health my_group
Fabric UUID:  5ca1ab1e-a007-feed-f00d-cab3fe13249e
Time-To-Live: 1

                                uuid is_alive  status is_not_running is_not_configured io_not_running sql_not_running io_error sql_error
------------------------------------ -------- ------- -------------- ----------------- -------------- --------------- -------- ---------
1c70d9dd-84e5-11e4-aac7-0800279a65c5        1 PRIMARY              0                 0              0               0    False     False
43f777a0-7f4a-11e4-863b-08002713b36f        0  FAULTY              0                 0              0               0    False     False
7f5ba91e-81d1-11e4-96b7-0800273900a5        0  FAULTY              0                 0              0               0    False     False

issue
-----
</code></pre>
</div>

<p>둘다 다시 올려보자.
그래도 계속 faulty임</p>

<h2 id="99-issue-handling">99. issue handling</h2>

<h3 id="991-regarding-protocolmysql">99.1 regarding protocol.mysql</h3>

<ul>
  <li>error</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>[mysql@testvm1 conf]$ mysqlfabric  --config=/db/mysql/conf/fabric.cfg manage setup
[INFO] 1418110319.957376 - MainThread - Initializing persister: user (fabric), server (localhost:3306), database (fabric).
Traceback (most recent call last):
  File "/usr/bin/mysqlfabric", line 443, in
    main()
  File "/usr/bin/mysqlfabric", line 424, in main
    fire_command(cmd, *cargs)
  File "/usr/bin/mysqlfabric", line 356, in fire_command
    result = command.dispatch(*(command.append_options_to_args(args)))
  File "/usr/lib/python2.6/site-packages/mysql/fabric/services/manage.py", line 170, in dispatch
    _persistence.MySQLPersister())
  File "/usr/lib/python2.6/site-packages/mysql/fabric/credentials.py", line 493, in check_initial_setup
    username = config.get(section, 'user')
  File "/usr/lib64/python2.6/ConfigParser.py", line 532, in get
    raise NoSectionError(section)
ConfigParser.NoSectionError: No section: 'protocol.mysql'
[mysql@testvm1 conf]$
</code></pre>
</div>

<ul>
  <li>solution
    <ul>
      <li>Please add the protocol.mysql section to the example configuration file, and to the manual page that lists all configuration file sections.</li>
    </ul>
  </li>
</ul>

<h3 id="992-same-uuid-when-cloning-mysql-instances">99.2 same UUID when cloning mysql instances</h3>

<ul>
  <li>solution
    <ul>
      <li>delete DATADIR/auto.cnf</li>
      <li>and restart</li>
    </ul>
  </li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>[mysql@testvm2 data]$ more auto.cnf
[auto]
server-uuid=63ff2650-0bfb-11e4-9653-080027637261
[mysql@testvm2 data]$ mv auto.cnf  auto.cnf.bak
[mysql@testvm2 data]$ /db/mydba/56_shutdown.sh
141209 13:22:42 mysqld_safe mysqld from pid file /data1/mysql/data/testvm2.pid ended
[mysql@testvm2 data]$ /db/mydba/56_startup.sh
[mysql@testvm2 data]$ 141209 13:22:46 mysqld_safe Logging to '/data1/mysql/data/mysql.err'.
141209 13:22:46 mysqld_safe Starting mysqld daemon with databases from /data1/mysql/data
[mysql@testvm2 data]$ more auto.cnf
[auto]
server-uuid=43f777a0-7f4a-11e4-863b-08002713b36f
</code></pre>
</div>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'minsql'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="http://localhost:4000/blog/BLOB-%EC%A0%80%EC%9E%A5%EB%B0%A9%EC%8B%9D-in-InnoDB/" class="btn" title="BLOB 저장방식 in InnoDB">Previous</a>
      
      
        <a href="http://localhost:4000/blog/MySQL-%EC%97%90%EB%9F%AC%EB%A9%94%EC%8B%9C%EC%A7%80-%EC%96%B8%EC%96%B4-%EC%84%A4%EC%A0%95/" class="btn" title="MySQL 에러메시지 언어 설정">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>&copy; 2018 MINSQL<!--. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.--></span>
<div class="social-icons">
	
	
	
	
	
	
	
	
	
  
	
  <a href="http://localhost:4000/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = 'http://localhost:4000';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>




</body>
</html>
